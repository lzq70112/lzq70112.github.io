(window.webpackJsonp=window.webpackJsonp||[]).push([[108],{576:function(s,n,a){"use strict";a.r(n);var e=a(20),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("K8S分层构建nginx+tomcat+NFS存储卷做动静分离访问")]),s._v(" "),a("h2",{attrs:{id:"_1、基础系统镜像建设"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、基础系统镜像建设"}},[s._v("#")]),s._v(" 1、基础系统镜像建设")]),s._v(" "),a("p",[s._v("》》"),a("a",{attrs:{href:"https://hongwei888.com/pages/b5e154215/",target:"_blank",rel:"noopener noreferrer"}},[s._v("harbor自动拉取镜像并上传脚本"),a("OutboundLink")],1),s._v("《《")]),s._v(" "),a("p",[a("code",[s._v("./harbor-container.sh centos:centos7.7.1908")])]),s._v(" "),a("p",[a("code",[s._v("vim Dockerfile")]),s._v(" #安装系统用户")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("FROM my.harbor.com/base/centos:centos7.7.1908\nMAINTAINER xiongmao\nADD filebeat-7.6.1-x86_64.rpm /tmp/\nRUN rm -rf /etc/yum.repos.d/*\nADD base.repo /etc/yum.repos.d/\nRUN yum install -y vim wget tree lrzsz automake pcre pcre-devel gcc gcc-c++ zlib zlib-devel openssl openssl-devel net-tools iotop unzip zip iproute ntpdate nfs-utils tcp dump telnet traceroute && rm -rf /etc/localtime && ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && useradd nginx -u 2020 && useradd www -u 2019 && yum install -y /tmp/filebeat-7.6.1-x86_64.rpm && rm -rf /tmp/filebeat-7.6.1-x86_64.rpm\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("code",[s._v("root@master-1:~/k8s.yaml/site/centos# tree")]),s._v(" #目录结构")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(".\n├── base.repo 阿里源centos\n├── Dockerfile #dockfile主体文件\n└── filebeat-7.6.1-x86_64.rpm #后期日志收集\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("code",[s._v("vim build-command.sh")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#!/bin/bash\ndocker build -t my.harbor.com/base/centos:base7.7.1908 .\nsleep 1\ndocker push my.harbor.com/base/centos:base7.7.1908\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("code",[s._v("bash build-command.sh")]),s._v(" #上传构建好的镜像")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906134734832.png",alt:"image-20210906134734832"}})]),s._v(" "),a("h2",{attrs:{id:"_2、nginx-基础镜像建设"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、nginx-基础镜像建设"}},[s._v("#")]),s._v(" 2、nginx 基础镜像建设")]),s._v(" "),a("p",[a("a",{attrs:{href:"http://nginx.org/en/download.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("nginx官方镜像下载"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("code",[s._v("vim Dockerfile")]),s._v(" #基础镜像")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#Nginx Base Image\nFROM my.harbor.com/base/centos:base7.7.1908\nMAINTAINER xiongmao\nADD nginx-1.14.2.tar.gz /usr/local/src/\nRUN yum install -y vim wget tree lrzsz gcc gcc-c++ automake pcre pcre-devel zlib zlibdevel openssl openssl-devel iproute net-tools iotop && cd /usr/local/src/nginx-1.14.2 && ./configure && make && make install && ln -sv /usr/local/nginx/sbin/nginx /usr/sbin/nginx && rm -rf /usr/local/src/nginx-1.14.2.tar.gz\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("code",[s._v("vim build-command.sh")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#!/bin/bash\ndocker build -t my.harbor.com/base/nginx-base:v1.14.2 .\nsleep 1\ndocker push my.harbor.com/base/nginx-base:v1.14.2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("code",[s._v("root@master-1:~/k8s.yaml/site/nginx# tree")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(".\n├── build-command.sh\n├── Dockerfile\n└── nginx-1.14.2.tar.gz\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906140844818.png",alt:"image-20210906140844818"}})]),s._v(" "),a("h2",{attrs:{id:"_3、nginx业务镜像建设"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、nginx业务镜像建设"}},[s._v("#")]),s._v(" 3、nginx业务镜像建设")]),s._v(" "),a("p",[a("code",[s._v("vim Dockerfile")]),s._v(" #基础镜像")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('#Nginx Base Image\nFROM my.harbor.com/base/nginx-base:v1.14.2\nADD nginx.conf /usr/local/nginx/conf/nginx.conf\nADD webapp/* /usr/local/nginx/html/webapp/\nADD index.html /usr/local/nginx/html/index.html\nRUN mkdir -p /usr/local/nginx/html/webapp/static /usr/local/nginx/html/webapp/images\nEXPOSE 80 443\nCMD ["nginx"]\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("code",[s._v("vim nginx.conf")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("user\tnginx nginx;\nworker_processes\tauto;\n\ndaemon off;\n\nevents { \n    worker_connections 1024;\n}\n\nhttp {\n    include\t\tmime.types;\n    default_type\tapplication/octet-stream;\n\n    sendfile\ton;\n    keepalive_timeout\t65;\n\n    server {\n        listen\t\t80;\n        server_name\tlocalhost;\n\n        location  /  {\n            root\thtml;\n            index\tindex.html index.htm;\n        }\n\n        location  webapp/  {\n            root\thtml;\n            index\tindex.html index.htm;\n\n    }\n\n        error_page\t500 502 503 504 /50x.html;\n        location = /50x.html {\n            root\thtml;\t\n        }\n    }\n}   \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br")])]),a("p",[a("code",[s._v('echo "nginx page" > index.html')])]),s._v(" "),a("p",[a("code",[s._v('echo "nginx webapp page" > webapp/index.html')])]),s._v(" "),a("p",[a("code",[s._v("vim build-command.sh")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#!/bin/bash\nTAG=$1\ndocker build -t my.harbor.com/webapp/nginx-web:${TAG} .\nsleep 1\ndocker push  my.harbor.com/webapp/nginx-web:${TAG}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("code",[s._v("bash build-command.sh v1")]),s._v(" #上传镜像")]),s._v(" "),a("p",[a("code",[s._v("root@master-1:~/k8s.yaml/site/nginx-web# tree")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(".\n├── build-command.sh\n├── Dockerfile\n├── index.html\n├── nginx.conf\n└── webapp\n    └── index.html\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906144056739.png",alt:"image-20210906144056739"}})]),s._v(" "),a("p",[a("code",[s._v("docker run -it --rm -p 80:80 my.harbor.com/webapp/nginx-web:v1")]),s._v(" #启动容器测试")]),s._v(" "),a("p",[a("code",[s._v("root@master-1:~# curl 127.0.0.1:/webapp/")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("nginx webapp page\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("root@master-1:~# curl 127.0.0.1")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("nginx page\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"_4、k8s部署nginx-nfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、k8s部署nginx-nfs"}},[s._v("#")]),s._v(" 4、K8S部署NGINX—NFS")]),s._v(" "),a("h3",{attrs:{id:"_4、1-安装nfs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、1-安装nfs"}},[s._v("#")]),s._v(" 4、1 安装nfs")]),s._v(" "),a("p",[a("code",[s._v("apt-get install nfs-kernel-server nfs-common rpcbind")]),s._v(" -y")]),s._v(" "),a("p",[a("code",[s._v("mkdir -p /data/webapp/images /data/webapp/static")]),s._v(" #创建共享目录")]),s._v(" "),a("p",[a("code",[s._v("vim /etc/exports")]),s._v(" #共享目录")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("/data/webapp *(rw,no_root_squash)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("systemctl enable nfs-server")])]),s._v(" "),a("p",[a("code",[s._v("systemctl restart nfs-server")])]),s._v(" "),a("p",[s._v("node 节点安装nfs")]),s._v(" "),a("p",[a("code",[s._v("apt-get install nfs-common rpcbind")]),s._v(" -y")]),s._v(" "),a("p",[a("code",[s._v("mount -t nfs my.nfs.com:/data/webapp /mnt")]),s._v(" #测试挂载")]),s._v(" "),a("h3",{attrs:{id:"_4、2部署nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、2部署nginx"}},[s._v("#")]),s._v(" 4、2部署nginx")]),s._v(" "),a("p",[a("code",[s._v("vim nginx.yml")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  labels:\n    app: nginx-deployment-label \n  name: nginx-deployment \n  namespace: nginx\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx-selector\n  template:\n    metadata:\n      labels:\n        app: nginx-selector\n    spec:\n      containers:\n      - name: nginx-container\n        image: my.harbor.com/webapp/nginx-web:v1\n        #imagePullPolicy: IfNotPresent\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 80\n          protocol: TCP\n          name: http\n        - containerPort: 443\n          protocol: TCP\n          name: https\n        env:\n        - name: "password"\n          value: "123456"\n        - name: "age"\n          value: "18"\n        resources:\n          limits:\n            cpu: 2\n            memory: 2Gi\n          requests:\n            cpu: 1\n            memory: 512Mi\n        volumeMounts:\n          - name: webapp\n            mountPath: /usr/local/nginx/html/webapp/images\n            readOnly: false\n          - name: static\n            mountPath: /usr/local/nginx/html/webapp/static\n            readOnly: false\n      volumes:\n      - name: webapp\n        nfs:\n          server: my.nfs.com\n          path: /data/webapp/images\n      - name: static\n        nfs: \n          server: my.nfs.com\n          path: /data/webapp/static \n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: nginx\n  name: nginx-spec\n  namespace: nginx\nspec:\n  type: NodePort\n  ports:\n  - name: http\n    port: 80\n    protocol: TCP\n    targetPort: 80\n    nodePort: 30002\n  - name: https\n    port: 443\n    protocol: TCP\n    targetPort: 443\n    nodePort: 30043\n  selector:\n    app: nginx-selector\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br")])]),a("p",[a("code",[s._v("vim nginx-ns.yml")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("apiVersion: v1\nkind: Namespace\nmetadata:\n  name: nginx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("strong",[s._v("创建ns和pod")])]),s._v(" "),a("p",[a("code",[s._v("kubectl apply -f webapp/nginx.yml")])]),s._v(" "),a("p",[a("code",[s._v("kubectl apply -f nginx-ns.yml")])]),s._v(" "),a("p",[a("strong",[s._v("测试")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906155737582.png",alt:"image-20210906155737582"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906155758187.png",alt:"image-20210906155758187"}})]),s._v(" "),a("h2",{attrs:{id:"_5、创建mha架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5、创建mha架构"}},[s._v("#")]),s._v(" 5、创建MHA架构")]),s._v(" "),a("p",[s._v("node节点端口暴露的容器不方便访问，因此加入MHA")]),s._v(" "),a("p",[a("code",[s._v("vim /etc/keepalived/keepalived.conf")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    virtual_ipaddress {\n\n        # optional label. should be of the form "realdev:sometext" for\n        # compatibility with ifconfig.\n        192.168.2.250 dev ens33 label ens33:1\n    }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("code",[s._v("vim /etc/haproxy/haproxy.cfg")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("`listen k8s-nginx-80\n       bind 192.168.2.250:80\n       mode tcp\n       server k8s-master 192.168.2.25:30002 check inter 3s fall 3 rise 5\n       server k8s-master 192.168.2.26:30002 check inter 3s fall 3 rise 5\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("code",[s._v("systemctl restart keepalived systemctl restart haproxy")])]),s._v(" "),a("p",[a("code",[s._v("systemctl enable keepalived systemctl enable haproxy")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906163102635.png",alt:"image-20210906163102635"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906163658639.png",alt:"image-20210906163658639"}})]),s._v(" "),a("h2",{attrs:{id:"_6、jdk基础镜像建设"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6、jdk基础镜像建设"}},[s._v("#")]),s._v(" 6、JDK基础镜像建设")]),s._v(" "),a("p",[s._v("》》"),a("a",{attrs:{href:"https://www.oracle.com/java/technologies/javase/javase8u211-later-archive-downloads.html#license-lightbox",target:"_blank",rel:"noopener noreferrer"}},[s._v("JD官方包"),a("OutboundLink")],1),s._v("《《")]),s._v(" "),a("p",[a("code",[s._v("vim Dokcerfile")]),s._v(" #尽管profile有参数，还是需要传递因为")]),s._v(" "),a("p",[s._v("Bash登陆(login)的时候，profile执行的顺序：先执行全局/etc/profile==》 接着bash会检查使用者的HOME目录中，是否有 .bash_profile 或者 .bash_login或者 .profile，若有，则会执行其中一个，执行顺序为：    .bash_profile 最优先 > .bash_login其次 > .profile")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("FROM my.harbor.com/base/centos:base7.7.1908\nMAINTAINER xiongmao\nADD jdk-8u212-linux-x64.tar.gz /usr/local/src/\nRUN ln -sv /usr/local/src/jdk1.8.0_212 /usr/local/jdk\nADD profile /etc/profile\nENV JAVA_HOME /usr/local/jdk\nENV JRE_HOME $JAVA_HOME/jre\nENV CLASSPATH $JAVA_HOME/lib/:$JRE_HOME/lib/\nENV PATH $PATH:$JAVA_HOME/bin\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[a("code",[s._v("vim profile")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# /etc/profile: system-wide .profile file for the Bourne shell (sh(1))\n# and Bourne compatible shells (bash(1), ksh(1), ash(1), ...).\n\nif [ "${PS1-}" ]; then\n  if [ "${BASH-}" ] && [ "$BASH" != "/bin/sh" ]; then\n    # The file bash.bashrc already sets the default PS1.\n    # PS1=\'\\h:\\w\\$ \'\n    if [ -f /etc/bash.bashrc ]; then\n      . /etc/bash.bashrc\n    fi\n  else\n    if [ "`id -u`" -eq 0 ]; then\n      PS1=\'# \'\n    else\n      PS1=\'$ \'\n    fi\n  fi\nfi\n\nif [ -d /etc/profile.d ]; then\n  for i in /etc/profile.d/*.sh; do\n    if [ -r $i ]; then\n      . $i\n    fi\n  done\n  unset i\nfi\n\nexport JAVA_HOME=/usr/local/jdk\nexport JRE_HOME=$JAVA_HOME/jre\nexport CLASSPATH=$JAVA_HOME/lib/:$JRE_HOME/lib/\nexport PATH=$PATH:$JAVA_HOME/bin\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("p",[a("code",[s._v("vim build-command.sh")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#!/bin/bash\ndocker build -t my.harbor.com/base/jdk-base:v8.212 .\nsleep 1\ndocker push my.harbor.com/base/jdk-base:v8.212\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("code",[s._v("bash build-command.sh")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906171758006.png",alt:"image-20210906171758006"}})]),s._v(" "),a("h2",{attrs:{id:"_7、tomcat基础镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7、tomcat基础镜像"}},[s._v("#")]),s._v(" 7、Tomcat基础镜像")]),s._v(" "),a("p",[s._v("》》"),a("a",{attrs:{href:"https://tomcat.apache.org/download-80.cgi",target:"_blank",rel:"noopener noreferrer"}},[s._v("tomcat"),a("OutboundLink")],1),s._v("《《")]),s._v(" "),a("p",[a("code",[s._v("vim Dokerfile")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("FROM my.harbor.com/base/jdk-base:v8.212\nMAINTAINER xiongmao\nRUN mkdir /apps /data/tomcat/webapps /data/tomcat/logs -pv\nADD apache-tomcat-8.5.43.tar.gz /apps\nRUN useradd tomcat -u 2021 && ln -sv /apps/apache-tomcat-8.5.43 /apps/tomcat && chown -R nginx.nginx /apps /data -R\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("code",[s._v("vim build-command.sh")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#!/bin/bash\ndocker build -t my.harbor.com/webapp/tomcat-base:v8.5.43 .\nsleep 1\ndocker push my.harbor.com/webapp/tomcat-base:v8.5.43\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906173541416.png",alt:"image-20210906173541416"}})]),s._v(" "),a("h2",{attrs:{id:"_8、tomcat业务镜像app制作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8、tomcat业务镜像app制作"}},[s._v("#")]),s._v(" 8、tomcat业务镜像app制作")]),s._v(" "),a("p",[a("code",[s._v("vim Dokerfile")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('FROM my.harbor.com/webapp/tomcat-base:v8.5.43\n\nADD catalina.sh /apps/tomcat/bin/catalina.sh\nADD server.xml /apps/tomcat/conf/server.xml\n#ADD myapp/* /data/tomcat/webapps/myapp/\nADD app1.tar.gz /data/tomcat/webapps/myapp/\nADD run_tomcat.sh /apps/tomcat/bin/run_tomcat.sh\nADD filebeat.yml /etc/filebeat/filebeat.yml\n\nRUN mkdir /usr/local/nginx/html/webapp/images /usr/local/nginx/html/webapp/static -p\nRUN chown -R nginx.nginx /data/ /apps/ /usr/local/nginx/html\nEXPOSE 8080 8443\nCMD ["/apps/tomcat/bin/run_tomcat.sh"]\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[a("strong",[s._v("进入容器拿配置文件")])]),s._v(" "),a("p",[a("code",[s._v("docker run -it --rm -p 8801:8080 my.harbor.com/webapp/tomcat-base:v8.5.43 bash")])]),s._v(" "),a("p",[a("code",[s._v("scp /apps/tomcat/bin/catalina.sh 192.168.2.22:/root/k8s.yaml/site-dockfile/tomcat-app")])]),s._v(" "),a("p",[a("code",[s._v("scp /apps/tomcat/conf/server.xml 192.168.2.22:/root/k8s.yaml/site-dockfile/tomcat-app")])]),s._v(" "),a("p",[a("code",[s._v("vim catalina.sh")]),s._v(" #添加java代码优化")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('JAVA_OPTS="-server -Xms1g -Xmx1g -Xss512k -Xmn1g -XX:CMSInitiatingOccupancyFraction=65 -XX:+UseFastAccessorMethods -XX:+AggressiveOpts -XX:+UseBiasedLocking -XX:-DisableExplicitGC -XX:MaxTenuringThreshold=10 -XX:NewSize=2048M -XX:MaxNewSize=2048M -XX:NewRatio=2 -XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5 -XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("vim server.xml")]),s._v(" #修改appBase 路径")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('      <Host name="localhost"  appBase="/data/tomcat/webapps"\n            unpackWARs="true" autoDeploy="true">\n\n        \x3c!-- SingleSignOn valve, share authentication between web applications\n             Documentation at: /docs/config/valve.html --\x3e\n        \x3c!--\n        <Valve className="org.apache.catalina.authenticator.SingleSignOn" />\n        --\x3e\n\n        \x3c!-- Access log processes all example.\n             Documentation at: /docs/config/valve.html\n             Note: The pattern used is equivalent to using pattern="common" --\x3e\n        <Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"\n               prefix="localhost_access_log" suffix=".txt"\n               pattern="%h %l %u %t &quot;%r&quot; %s %b" />\n\n      </Host>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[a("code",[s._v("vim run_tomcat.sh")]),s._v(" #启动文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('#!/bin/bash\nsu - nginx -c "/apps/tomcat/bin/catalina.sh start"\ntail -f /etc/hosts\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("code",[s._v("vim filebeat.yml")]),s._v("#后期日志收集要用")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('filebeat.prospectors:\n- input_type: log\n  paths:\n    - /app/tomcat/logs/cataline.out\n  fields:\n    type: tomcat-cayaline\n\noutput.redis:\n  hosts: ["10.203.104.20:6379"]\n  key: "jevon-app1"\n  db: 1\n  timeout: 5\n  password: 12345\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[a("code",[s._v("vim build-command.sh")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#!/bin/bash\nTAG=$1\ndocker build -t my.harbor.com/webapp/tomcat-app:${TAG} .\nsleep 3\ndocker push my.harbor.com/webapp/tomcat-app:${TAG}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("code",[s._v("chmod o+x *.sh")]),s._v(" #为脚本添加执行权限，容器当中所使用的")]),s._v(" "),a("p",[a("code",[s._v("tree")]),s._v(" #目录结构")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(".\n├── app1.tar.gz\n├── build-command.sh\n├── catalina.sh\n├── Dockerfile\n├── filebeat.yml\n├── index.html\n├── run_tomcat.sh\n└── server.xml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906185905915.png",alt:"image-20210906185905915"}})]),s._v(" "),a("h2",{attrs:{id:"_9、k8s部署tomcat"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_9、k8s部署tomcat"}},[s._v("#")]),s._v(" 9、k8s部署tomcat")]),s._v(" "),a("p",[s._v("vim tomcat-app1.yaml")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('kind: Deployment\napiVersion: apps/v1\nmetadata:\n  labels:\n    app: tomcat-app1-deployment-label \n  name: tomcat-app1-deployment-label\n  namespace: nginx\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: tomcat-app1-selector\n  template:\n    metadata:\n      labels:\n        app: tomcat-app1-selector\n    spec:\n      containers:\n      - name: tomcat-app1-container\n        image: my.harbor.com/webapp/tomcat-app:v1\n        #imagePullPolicy: IfNotPresent\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n          name: http\n        env:\n        - name: "password"\n          value: "123456"\n        - name: "age"\n          value: "18"\n        resources:\n          limits:\n            cpu: 2\n            memory: 2Gi\n          requests:\n            cpu: 1\n            memory: 512Mi\n        volumeMounts:\n        - name: images\n          mountPath: /usr/local/nginx/html/webapp/images\n          readOnly: false\n        - name: static\n          mountPath: /usr/local/nginx/html/webapp/static\n          readOnly: false\n      volumes:\n      - name: images\n        nfs:\n          server: my.nfs.com\n          path: /data/webapp/images\n      - name: static\n        nfs:\n          server: my.nfs.com\n          path: /data/webapp/static\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: tomcat-app1-service-label\n  name: tomcat-app1-service\n  namespace: nginx\nspec:\n  type: NodePort\n  ports:\n  - name: http\n    port: 80\n    protocol: TCP\n    targetPort: 8080\n    nodePort: 30004\n  selector:\n    app: tomcat-app1-selector\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906195528268.png",alt:"image-20210906195528268"}})]),s._v(" "),a("h2",{attrs:{id:"_10、k8s部署nginx-tomcat实现动静分离"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10、k8s部署nginx-tomcat实现动静分离"}},[s._v("#")]),s._v(" 10、K8S部署nginx+tomcat实现动静分离")]),s._v(" "),a("p",[a("code",[s._v("kubectl get service -n nginx")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("NAME                  TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE\nnginx-spec            NodePort   10.68.139.254   <none>        80:30002/TCP,443:30043/TCP   4h19m\ntomcat-app1-service   NodePort   10.68.120.249   <none>        80:30004/TCP                 28m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("code",[s._v("vim nginx.conf")]),s._v(" #修改nginx.conf 修改nginx业务镜像实现动静分离")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("user\tnginx nginx;\nworker_processes\tauto;\n\ndaemon off;\n\nevents { \n    worker_connections 1024;\n}\n\nhttp {\n    include\t\tmime.types;\n    default_type\tapplication/octet-stream;\n\n    sendfile\ton;\n    keepalive_timeout\t65;\n\n    upstream tomcat_webserver {\n       server tomcat-app1-service.nginx.svc.cluster.local:80;\n    }\n    server {\n        listen\t\t80;\n        server_name\tlocalhost;\n\n        location  /  {\n            root\thtml;\n            index\tindex.html index.htm;\n        }\n\n        location  webapp/  {\n            root\thtml;\n            index\tindex.html index.htm;\n\n        }\n        location /myapp {\n            proxy_pass http://tomcat_webserver;\n            proxy_set_header Host $host;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Real-IP $remote_addr;\n        }\n\n        error_page\t500 502 503 504 /50x.html;\n        location = /50x.html {\n            root\thtml;\t\n        }\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br")])]),a("p",[a("code",[s._v("bash build-command.sh v2")]),s._v(" #更改nginx配置")]),s._v(" "),a("p",[a("code",[s._v("cp nginx.yml nginx:v2.yml")]),s._v(" #修改为v2")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("        image: my.harbor.com/webapp/nginx-web:v2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("kubectl apply -f nginx-v2.yml")]),s._v("#重新部署")]),s._v(" "),a("p",[a("strong",[s._v("测试nginx+tomcat 动态")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906204545227.png",alt:""}})]),s._v(" "),a("p",[a("strong",[s._v("测试nginx")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906204705507.png",alt:"image-20210906204705507"}})]),s._v(" "),a("p",[a("strong",[s._v("测试静态")])]),s._v(" "),a("hr"),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210906204830855.png",alt:"image-20210906204830855"}})])])}),[],!1,null,null,null);n.default=t.exports}}]);