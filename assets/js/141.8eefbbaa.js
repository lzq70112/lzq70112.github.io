(window.webpackJsonp=window.webpackJsonp||[]).push([[141],{611:function(s,a,e){"use strict";e.r(a);var t=e(20),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("环境")]),s._v(" "),e("p",[s._v("K8S版本信息: 1.2.1.8")]),s._v(" "),e("p",[s._v("runtime：containerd")]),s._v(" "),e("p",[s._v("由于事故现场有断电、存储挂过，三台master全部在虚拟机，外挂统一云存储、云存储宕机后，数据恢复，虚拟机伴随着云存储断电一起断电,有部分系统数据丢失。")]),s._v(" "),e("p",[s._v("现象环境虚机内的容器、集群全部不可用、尝试彻底恢复")]),s._v(" "),e("ol",[e("li",[s._v("最好有独立的镜像仓库、在集群之外")]),s._v(" "),e("li",[s._v("有"),e("code",[s._v("ETCD")]),s._v("的周期备份")]),s._v(" "),e("li",[s._v("整体业务数据是已经恢复的，集群不可用")])]),s._v(" "),e("h2",{attrs:{id:"_1、环境确认与恢复"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1、环境确认与恢复"}},[s._v("#")]),s._v(" 1、环境确认与恢复")]),s._v(" "),e("p",[s._v("容器是否能够正常启动")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("systemctl status containerd "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#查看服务状态")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("nerdctl -n k8s.io "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -a "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看容器状态")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("大部分容器都是"),e("code",[s._v("unkown")])]),s._v(" "),e("p",[s._v("重启容器")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("nerdctl -n k8s.io restart  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#重启容失败")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/202206241554496.png",alt:"image-20220624155426968"}})]),s._v(" "),e("p",[s._v("进程的"),e("code",[s._v("ns")]),s._v("文件全部丢失，"),e("code",[s._v("containerd")]),s._v("对容器无法进行管控")]),s._v(" "),e("h2",{attrs:{id:"_2、备份containerd的数据文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2、备份containerd的数据文件"}},[s._v("#")]),s._v(" 2、备份"),e("code",[s._v("containerd")]),s._v("的数据文件")]),s._v(" "),e("p",[s._v("停止"),e("code",[s._v("containerd")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("systemctl stop containerd\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mv   /data/containerd/  /data/containerd_back\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v(" /data/files/container_service/files/images/"),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("arch"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("/下面 "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#导入镜像")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("i")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("nerdctl -n k8s.io load -i "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#批量导入")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 批量修改tag号，需要去除amd64")]),s._v("\nnerdctl -n k8s.io images "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1\" \"$2}'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -v  TAG "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /tmp/images.txt\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("read")]),s._v(" image_name version\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tag")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" $version"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/-amd64//g'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n  nerdctl -n k8s.io tag "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$image_name")]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$version")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$image_name")]),s._v(":tag\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" /tmp/images.txt\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h2",{attrs:{id:"_3、处理残留进程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3、处理残留进程"}},[s._v("#")]),s._v(" 3、处理残留进程")]),s._v(" "),e("p",[s._v("如果静态pod的")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" /etc/kubernetes/manifests  /etc/kubernetes/manifests_back "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#移除静态pod")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("二进制安装的分别停止一下服务")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("systemctl stop etcd  \nsystemctl stop kube-apiserver \nsystemctl stop kube-controller-manager \nsystemctl stop kube-scheduler\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("清除"),e("code",[s._v("containerd")]),s._v("的进程残留")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -ef "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" containerd.sock "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" -9  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#清除进程残留，防止后续服务启动冲突")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"_4、还原etcd"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4、还原etcd"}},[s._v("#")]),s._v(" 4、还原"),e("code",[s._v("etcd")])]),s._v(" "),e("p",[s._v("参考本站的"),e("code",[s._v("etcd")]),s._v("备份还原篇")]),s._v(" "),e("h2",{attrs:{id:"_5、查看集群状态"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5、查看集群状态"}},[s._v("#")]),s._v(" 5、查看集群状态")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("systemctl start containerd "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl restart kubelet\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("kubectl get pod -n kube-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("nerdctl -n k8s.io  run --rm   -v "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd'")]),s._v(" -v "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/u01/local/kube-system:/u01/local/kube-system'")]),s._v("   --env "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCDCTL_API")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker.xiongmao.com:15000/etcd:3.5.0-0"')]),s._v(" /bin/sh -c   "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcdctl --endpoints=https://131.106.7.44:2379            --cert=/etc/kubernetes/pki/etcd/server.crt  --key=/etc/kubernetes/pki/etcd/server.key --cacert=/etc/kubernetes/pki/etcd/ca.crt member list"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看集群恢复信息")]),s._v("\n\nnerdctl -n k8s.io  run --rm   -v "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd'")]),s._v(" -v "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/u01/local/kube-system:/u01/local/kube-system'")]),s._v("   --env "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCDCTL_API")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker.xiongmao.com:15000/etcd:3.5.0-0"')]),s._v(" /bin/sh -c   "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcdctl --endpoints=https://131.106.7.44:2379            --cert=/etc/kubernetes/pki/etcd/server.crt  --key=/etc/kubernetes/pki/etcd/server.key --cacert=/etc/kubernetes/pki/etcd/ca.crt  --write-out=table endpoint status"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看集群端口信息")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"_6、恢复非集群的基础容器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6、恢复非集群的基础容器"}},[s._v("#")]),s._v(" 6、恢复非集群的基础容器")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -fr /var/lib/nerdctl/1935db59/names/k8s.io/* "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#删除由nerdctl生成的缓存目录")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("拉取基础容器")])])}),[],!1,null,null,null);a.default=n.exports}}]);