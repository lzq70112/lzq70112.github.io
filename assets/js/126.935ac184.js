(window.webpackJsonp=window.webpackJsonp||[]).push([[126],{595:function(s,t,a){"use strict";a.r(t);var n=a(20),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_1、环境描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、环境描述"}},[s._v("#")]),s._v(" 1、环境描述")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("版本:Uniontech OS Server 20 Enterprise \\n \\l\n架构：arm64\ncalico版本：v3.19.1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"_2、故障现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、故障现象"}},[s._v("#")]),s._v(" 2、故障现象")]),s._v(" "),a("p",[s._v("calico不断重启报错")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-05-26 02:40:02.355 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3912")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" felix/table.go "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1324")]),s._v(": Failed to execute ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("tables-restore "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("error")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exit status "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("errorOutput")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v('"iptables-nft-restore v1.8.4 '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nf_tables"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": unknown arguments found on commandline"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("nError occurred at line: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("nTry `iptables-nft-restore -h"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("' or '")]),s._v("iptables-nft-restore --help' "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" information."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" input="')]),s._v("*raw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n:cali-from-host-endpoint - -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n:cali-to-host-endpoint - -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n:cali-PREROUTING - -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n:cali-OUTPUT - -"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n-A cali-PREROUTING -m comment --comment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"cali:XFX5xbM8B9qR10JG'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('" --jump MARK --set-mark '),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/0xf0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n-A cali-PREROUTING -m comment --comment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"cali:EWMPb0zVROM-woQp'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('" --in-interface cali+ --jump MARK --set-mark 0x40000/0x40000'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n-A cali-PREROUTING -m comment --comment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"cali:mPIOOWmbH3iO0R90'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('" -m mark --mark 0x40000/0x40000 -m rpfilter --invert --validmark --jump DROP'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n-A cali-PREROUTING -m comment --comment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"cali:8eOxmFpkWr0RjKXR'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('" -m mark --mark '),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/0x40000 --jump cali-from-host-endpoint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n-A cali-PREROUTING -m comment --comment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"cali:F-nExspj_POyei0v'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('" -m mark --mark 0x10000/0x10000 --jump ACCEPT'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n-A cali-OUTPUT -m comment --comment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"cali:njdnLwYeGqBJyMxW'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('" --jump MARK --set-mark '),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/0xf0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n-A cali-OUTPUT -m comment --comment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"cali:rz86uTUcEZAfFsh7'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('" --jump cali-to-host-endpoint'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n-A cali-OUTPUT -m comment --comment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"cali:pN0F5zD0b8yf9W1Z'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('" -m mark --mark 0x10000/0x10000 --jump ACCEPT'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n-I PREROUTING -m comment --comment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"cali:6gwbT8clXdHdC1b1'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('" --jump cali-PREROUTING'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n-I OUTPUT -m comment --comment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"cali:tVnHkvAo15HuiPy0'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('" --jump cali-OUTPUT'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("nCOMMIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" ipVersion=0x4 output="')]),s._v('" '),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"raw"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-05-26 02:40:02.355 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3912")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" felix/table.go "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("997")]),s._v(": Failed to program iptables, will retry "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("error")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exit status "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ipVersion")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("0x4 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("table")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"raw"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"_3、解决思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、解决思路"}},[s._v("#")]),s._v(" 3、解决思路")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("root@node-miei:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -l /usr/sbin/iptables")]),s._v("\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 09:29 /usr/sbin/iptables -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/alternatives/iptables\nroot@node-miei:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -l /etc/alternatives/iptables")]),s._v("\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v(" Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":16 /etc/alternatives/iptables -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/sbin/iptables-nft\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("原来再存在两个版本的"),a("code",[s._v("iptables")]),s._v("，他们分别是"),a("code",[s._v("iptables-nft")]),s._v("和"),a("code",[s._v("iptables-legacy")]),s._v("这两个"),a("code",[s._v("iptables")]),s._v("使用了不同的内核模块。"),a("code",[s._v("uos")]),s._v("默认使用的是"),a("code",[s._v("iptables-nft")]),s._v("而"),a("code",[s._v("amd64")]),s._v("默认使用的是"),a("code",[s._v("iptables")]),s._v("。因为"),a("code",[s._v("iptables-nft")]),s._v("与"),a("code",[s._v("iptables-legacy")]),s._v("不同，"),a("code",[s._v("iptables-nft")]),s._v("在calico初始化时没有对应参数从而报错。")]),s._v(" "),a("p",[s._v("需要"),a("code",[s._v("iptables")]),s._v("的版本换成"),a("code",[s._v("iptables-legacy")]),s._v("的")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("update-alternatives --config iptables\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/202205261633307.png",alt:"image-20220526163357313"}})]),s._v(" "),a("p",[s._v("update-alternatives 命令选项介绍：display、install、remove、config")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("update-alternatives --display iptables "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#查看iptables版本")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("iptables - manual mode\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" best version is /usr/sbin/iptables-nft\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" currently points to /usr/sbin/iptables-legacy\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 此处指向的/usr/sbin/iptables-legacy")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" iptables is /usr/sbin/iptables\n  slave iptables-restore is /usr/sbin/iptables-restore\n  slave iptables-save is /usr/sbin/iptables-save\n/usr/sbin/iptables-legacy - priority "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n  slave iptables-restore: /usr/sbin/iptables-legacy-restore\n  slave iptables-save: /usr/sbin/iptables-legacy-save\n/usr/sbin/iptables-nft - priority "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("\n  slave iptables-restore: /usr/sbin/iptables-nft-restore\n  slave iptables-save: /usr/sbin/iptables-nft-save\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);