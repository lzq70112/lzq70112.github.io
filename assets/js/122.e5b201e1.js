(window.webpackJsonp=window.webpackJsonp||[]).push([[122],{592:function(s,a,t){"use strict";t.r(a);var n=t(20),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"_1、场景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、场景"}},[s._v("#")]),s._v(" 1、场景")]),s._v(" "),t("p",[s._v("随着"),t("code",[s._v("k8s")]),s._v("普及，"),t("code",[s._v("k8s")]),s._v("的"),t("code",[s._v("nfs")]),s._v("云存储使用十分频繁，现在对于"),t("code",[s._v("nfs")]),s._v("的云存储挂载选项"),t("code",[s._v("lock / nolock")]),s._v("导致的问题做出分析")]),s._v(" "),t("p",[s._v("备注 :"),t("code",[s._v("nfs v3")]),s._v("的锁是通过"),t("code",[s._v("nlm")]),s._v("协议处理的，"),t("code",[s._v("nfs v4")]),s._v("的锁是"),t("code",[s._v("nfs")]),s._v(" 自己处理的，本篇所说的都是"),t("code",[s._v("nfs v3")]),s._v("的")]),s._v(" "),t("p",[s._v("什么是"),t("code",[s._v("local_lock")]),s._v("与"),t("code",[s._v("lock / nolock")])]),s._v(" "),t("p",[s._v("首先我们查看命令帮助")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("man")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" nfs "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#查看nfs的选项")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#其中nolock的解释")]),s._v("\n lock / nolock  Selects whether to use the NLM sideband protocol to lock files on the server.  If neither option is specified "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("or "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" lock is specified"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", NLM  locking  is  used  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v("  this  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v("\n                  point.   When using the nolock option, applications can lock files, but such locks provide exclusion only against other applications running on the same client.  Remote applica‐\n                  tions are not affected by these locks.\n\n                  NLM locking must be disabled with the nolock option when using NFS to "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" /var because /var contains files used by the NLM implementation on Linux.  Using the nolock option is\n                  also required when mounting exports on NFS servers that "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" not support the NLM protocol.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#local_lock的解释")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("local_lock")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mechanism\n                      Specifies  whether  to use "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" locking "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" any or both of the flock and the POSIX locking mechanisms.  mechanism can be one of all, flock, posix, or none.  This option is sup‐\n                      ported "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" kernels "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.6")]),s._v(".37 and later.\n\n                      The Linux NFS client provides a way to "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" locks local. This means, the applications can lock files, but such locks provide exclusion only against other applications running on\n                      the same client. Remote applications are not affected by these locks.\n\n                      If this option is not specified, or "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" none is specified, the client assumes that the locks are not local.\n\n                      If all is specified, the client assumes that both flock and POSIX locks are local.\n\n                      If flock is specified, the client assumes that only flock locks are "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" and uses NLM sideband protocol to lock files when POSIX locks are used.\n\n                      If posix is specified, the client assumes that POSIX locks are "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" and uses NLM sideband protocol to lock files when flock locks are used.\n\n                      To  support legacy flock behavior similar to that of NFS clients "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.6")]),s._v(".12, use "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'local_lock=flock'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" This option is required when exporting NFS mounts via Samba as Samba maps Win‐\n                      dows share mode locks as flock. Since NFS clients "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.6")]),s._v(".12 implement flock by emulating POSIX locks, this will result "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" conflicting locks.\n\n                      NOTE: When used together, the "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'local_lock'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" option will be overridden by "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nolock'")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'lock'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" option.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("h2",{attrs:{id:"_2、查看k8s的挂载"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、查看k8s的挂载"}},[s._v("#")]),s._v(" 2、查看k8s的挂载")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("storage-test3.bestkunlun.com:/k8s_cloudtest3_ustp_yace/ustp-yace-mnt-pvc-284c41d2-7889-48f7-9562-6db0899fb1fc on /mnt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" nfs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw,relatime,vers"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(",rsize"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v(",wsize"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v(",namlen"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("255")]),s._v(",hard,proto"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("tcp,timeo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v(",retrans"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",sec"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sys,mountaddr"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.165")]),s._v(".136.19,mountvers"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(",mountport"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2049")]),s._v(",mountproto"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("tcp,local_lock"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("none,addr"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.165")]),s._v(".136.19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"_3、local-lock与nolock"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、local-lock与nolock"}},[s._v("#")]),s._v(" 3、local_lock与nolock")]),s._v(" "),t("h3",{attrs:{id:"_3-1、k8s挂载默认为local-lock-all"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1、k8s挂载默认为local-lock-all"}},[s._v("#")]),s._v(" 3.1、K8S挂载默认为local_lock=all")]),s._v(" "),t("p",[t("code",[s._v("local_lock=none")]),s._v("没有指定任何选项，客户端就会认为这些锁不是本地的。如果指定了all，客户端会认为flock和POSIX锁都是本地锁。")]),s._v(" "),t("p",[s._v("等于all时 "),t("code",[s._v("flock")]),s._v("和"),t("code",[s._v("POSIX")]),s._v("都会对文件加锁")]),s._v(" "),t("h3",{attrs:{id:"_3-2、nolock"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2、nolock"}},[s._v("#")]),s._v(" 3.2、nolock")]),s._v(" "),t("p",[s._v("当使用"),t("code",[s._v("nolock")]),s._v("选项时，应用程序可以锁定文件，但这种锁只对在同一客户机上运行的其他应用程序提供排除。 远程应用锁定不受这些锁的影响。")]),s._v(" "),t("p",[s._v("当使用NFS挂载/var时，必须用nolock选项禁用NLM锁，因为/var包含Linux上NLM实现所使用的文件。")]),s._v(" "),t("p",[s._v("注意：'local_lock'挂载选项将被'nolock'/'lock'挂载选项所覆盖。")]),s._v(" "),t("h2",{attrs:{id:"_4、pv、pvc、sc与nfs配置关联"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、pv、pvc、sc与nfs配置关联"}},[s._v("#")]),s._v(" 4、pv、pvc、sc与nfs配置关联")]),s._v(" "),t("p",[s._v("当多个pod对云存储文件锁定  local_lock如果指定了all，客户端会认为flock和POSIX锁都是本地锁。造成文件的锁定，所以需要加入nolock属性或者local_lock指定none")]),s._v(" "),t("p",[s._v("pv挂载指定添加"),t("code",[s._v("nolock")]),s._v("选项")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[s._v("  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("claimRef")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolumeClaim\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pvc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("private"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nmedia\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" record3\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resourceVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"276006963"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("uid")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 252e6dda"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("b978"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("442f"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("aa25"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("791c53c22698\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountOptions")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nolock\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 此属性")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("sc载指定添加"),t("code",[s._v("nolock")]),s._v("选项后续创建pv都会携带此属性")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountOptions")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nolock\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);