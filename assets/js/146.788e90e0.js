(window.webpackJsonp=window.webpackJsonp||[]).push([[146],{616:function(e,s,t){"use strict";t.r(s);var a=t(20),r=Object(a.a)({},(function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("引用官方："),t("a",{attrs:{href:"https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/#node-allocatable",target:"_blank",rel:"noopener noreferrer"}},[e._v("地址"),t("OutboundLink")],1)]),e._v(" "),t("h2",{attrs:{id:"_1、问题描述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、问题描述"}},[e._v("#")]),e._v(" 1、问题描述")]),e._v(" "),t("p",[e._v("业务反馈节点内存才使用了86%的内存，但是describe node出来使用了96%，是因为节点设置了预留内存")]),e._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[e._v("kubectl describe "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("node")]),e._v(" node-c61q\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/202206081652645.png",alt:"clipboard"}})]),e._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/202206081656663.png",alt:"clipboard (1)"}})]),e._v(" "),t("p",[e._v("默认情况下pod能够使用节点全部可用资源。如果用户pod中的应用存在异常，例如疯狂占用内存，那么这些pod将与node上的系统守护进程和k8s组件争夺资源并导致节点资源短缺，从而产生node not ready问题。")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("NodeAllocatable = [NodeCapacity] - [kube-reserved] - [system-reserved] - [eviction-threshold]\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("ul",[t("li",[e._v("Node Capacity：Node的所有硬件资源")]),e._v(" "),t("li",[e._v("kube-reserved：给kube组件预留的资源")]),e._v(" "),t("li",[e._v("system-reserved：给System进程预留的资源")]),e._v(" "),t("li",[e._v("eviction-threshold：kubelet eviction的阈值设定")]),e._v(" "),t("li",[e._v("Allocatable：真正scheduler调度Pod时的参考值（保证Node上所有Pods的request resource不超过Allocatable）")])]),e._v(" "),t("h2",{attrs:{id:"_2、原因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、原因"}},[e._v("#")]),e._v(" 2、原因")]),e._v(" "),t("p",[e._v("k8s设置了"),t("code",[e._v("eviction-threshold")]),e._v(" 资源的限制")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/202206081709342.png",alt:"clipboard"}})]),e._v(" "),t("h2",{attrs:{id:"_3、扩展-kubelet添加额外启动参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、扩展-kubelet添加额外启动参数"}},[e._v("#")]),e._v(" 3、扩展-kubelet添加额外启动参数")]),e._v(" "),t("p",[e._v("可配置在"),t("code",[e._v("kubelet /var/lib/kubelet/config.yaml")]),e._v("配置文件，或者"),t("code",[e._v("/var/lib/kubelet/kubeadm-flags.env")]),e._v("启动参数")]),e._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[e._v("--enforce-node-allocatable"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("pods,kube-reserved,system-reserved\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#开启为kube组件和系统守护进程预留资源的功能")]),e._v("\n--kube-reserved-cgroup"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/system.slice/kubelet.service\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#设置k8s组件的cgroup")]),e._v("\n--system-reserved-cgroup"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/system.slice\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#设置系统守护进程的cgroup")]),e._v("\n--kube-reserved"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("cpu"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("200m,memory"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("250Mi\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#配置为k8s组件预留资源的大小，CPU、Mem")]),e._v("\n--system-reserved"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("cpu"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("200m,memory"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("250Mi\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#配置为系统守护进程预留资源的大小（预留的值需要根据机器上容器的密度做一个合理的值）")]),e._v("\n--eviction-hard"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("memory.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("5")]),e._v("%,nodefs.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("%,imagefs.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("%\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#驱逐pod的配置：硬阈值（保证95%的内存利用率）")]),e._v("\n--eviction-soft"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("memory.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("%,nodefs.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("15")]),e._v("%,imagefs.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("15")]),e._v("%\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#驱逐pod的配置：软阈值")]),e._v("\n--eviction-soft-grace-period"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("memory.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("2m,nodefs.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("2m,imagefs.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("2m\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("##定义达到软阈值之后，持续时间超过多久才进行驱逐")]),e._v("\n--eviction-max-pod-grace-period"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("30")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#驱逐pod前最大等待时间=min(pod.Spec.TerminationGracePeriodSeconds, eviction-max-pod-grace-period)，单位秒")]),e._v("\n--eviction-minimum-reclaim"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("memory.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" 0Mi,nodefs.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("500Mi,imagefs.available"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("500Mi\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br"),t("span",{staticClass:"line-number"},[e._v("13")]),t("br"),t("span",{staticClass:"line-number"},[e._v("14")]),t("br"),t("span",{staticClass:"line-number"},[e._v("15")]),t("br"),t("span",{staticClass:"line-number"},[e._v("16")]),t("br"),t("span",{staticClass:"line-number"},[e._v("17")]),t("br"),t("span",{staticClass:"line-number"},[e._v("18")]),t("br"),t("span",{staticClass:"line-number"},[e._v("19")]),t("br")])]),t("p",[e._v("当系统内存不足时，就有可能触发系统 OOM，这时候根据 oom score 来确定优先杀死哪个进程，而 oom_score_adj 又是影响 oom score 的重要参数，其值越低，表示 oom 的优先级越低。在计算节点中，进程的 oom_score_adj 如下：")]),e._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"center"}},[e._v("sshd 等")]),e._v(" "),t("th",{staticStyle:{"text-align":"center"}},[e._v("K8S 管理进程")]),e._v(" "),t("th",{staticStyle:{"text-align":"center"}},[e._v("guarantee pod")]),e._v(" "),t("th",{staticStyle:{"text-align":"center"}},[e._v("其它进程")]),e._v(" "),t("th",{staticStyle:{"text-align":"center"}},[e._v("best effort pod")])])]),e._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"center"}},[e._v("具体进程")]),e._v(" "),t("td",{staticStyle:{"text-align":"center"}},[e._v("sshd／dmevented / systemd-udevd")]),e._v(" "),t("td",{staticStyle:{"text-align":"center"}},[e._v("kubelet / docker / journalctl")]),e._v(" "),t("td",{staticStyle:{"text-align":"center"}},[e._v("guarantee pod")]),e._v(" "),t("td",{staticStyle:{"text-align":"center"}},[e._v("内核 init 进程等")])]),e._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[e._v("oom_score_adj")]),e._v(" "),t("td",{staticStyle:{"text-align":"center"}},[e._v("-1000")]),e._v(" "),t("td",{staticStyle:{"text-align":"center"}},[e._v("-999")]),e._v(" "),t("td",{staticStyle:{"text-align":"center"}},[e._v("-998")]),e._v(" "),t("td",{staticStyle:{"text-align":"center"}},[e._v("0")])])])]),e._v(" "),t("p",[e._v("所以，很大概率上，OOM 的优先级如下：\nbest effort pod > 其它进程 > guarantee pod > kubelet/docker 等 > sshd 等。\n如果节点没有 best effort 类型的 pod，那么其它进程就有可能被 OOM，包括系统进程等。")]),e._v(" "),t("h2",{attrs:{id:"_4、添加cgroup-subsystem"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、添加cgroup-subsystem"}},[e._v("#")]),e._v(" 4、添加cgroup subsystem")]),e._v(" "),t("p",[e._v("在Kubernetes 1.8版本，kubelet启动会检查以下cgroup subsystem的存在："),t("code",[e._v("cpu、cpuacct、cpuset、memory、systemd")]),e._v("。所以需要确保这些cgroup目录的存在。")]),e._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[e._v("mkdir")]),e._v(" -p /sys/fs/cgroup/cpu/system.slice/kubelet.service\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("mkdir")]),e._v(" -p /sys/fs/cgroup/cpuacct/system.slice/kubelet.service\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("mkdir")]),e._v(" -p /sys/fs/cgroup/cpuset/system.slice/kubelet.service\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("mkdir")]),e._v(" -p /sys/fs/cgroup/memory/system.slice/kubelet.service\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("mkdir")]),e._v(" -p /sys/fs/cgroup/systemd/system.slice/kubelet.service\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br")])])])}),[],!1,null,null,null);s.default=r.exports}}]);