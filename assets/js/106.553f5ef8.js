(window.webpackJsonp=window.webpackJsonp||[]).push([[106],{574:function(n,e,s){"use strict";s.r(e);var a=s(20),l=Object(a.a)({},(function(){var n=this,e=n.$createElement,s=n._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[s("p",[n._v("kubeasz3部署fannel篇"),s("br")]),n._v(" "),s("h2",{attrs:{id:"_1、原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1、原理"}},[n._v("#")]),n._v(" 1、原理")]),n._v(" "),s("p",[n._v("Flannel是CoreOS团队针对Kubernetes设计的一个网络规划服务，简单来说，它的功能是让集群中的不同节点主机创建的Docker容器都具有全集群唯一的虚拟IP地址。")]),n._v(" "),s("p",[n._v("在默认的Docker配置中，每个节点上的Docker服务会分别负责所在节点容器的IP分配。这样导致的一个问题是，不同节点上容器可能获得相同的内外IP地址。并使这些容器之间能够之间通过IP地址相互找到，也就是相互ping通。")]),n._v(" "),s("p",[n._v("Flannel的设计目的就是为集群中的所有节点重新规划IP地址的使用规则，从而使得不同节点上的容器能够获得“同属一个内网”且”不重复的”IP地址，并让属于不同节点上的容器能够直接通过内网IP通信。")]),n._v(" "),s("p",[n._v("Flannel实质上是一种“覆盖网络(overlaynetwork)”，也就是将TCP数据包装在另一种网络包里面进行路由转发和通信，目前已经支持udp、vxlan、host-gw、aws-vpc、gce和alloc路由等数据转发方式，默认的节点间数据通信方式是UDP转发。")]),n._v(" "),s("h2",{attrs:{id:"_2、fannel配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2、fannel配置"}},[n._v("#")]),n._v(" 2、fannel配置")]),n._v(" "),s("p",[n._v("1.flannel利用Kubernetes API或者etcd用于存储整个集群的网络配置，根据配置记录集群使用的网段。")]),n._v(" "),s("p",[n._v("2.flannel在每个主机中运行flanneld作为agent，它会为所在主机从集群的网络地址空间中，获取一个小的网段subnet，本主机内所有容器的IP地址都将从中分配。")]),n._v(" "),s("p",[n._v("如node节点中ip分配：")]),n._v(" "),s("p",[s("code",[n._v("cat /run/flannel/subnet.env")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("FLANNEL_NETWORK=172.20.0.0/16\nFLANNEL_SUBNET=172.20.3.1/24\nFLANNEL_MTU=1450\nFLANNEL_IPMASQ=true\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br")])]),s("p",[s("code",[n._v("vim /etc/kubeasz/clusters/k8s-01/config.yml")]),n._v(" #主体配置文件")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('# role:network [flannel,calico,cilium,kube-ovn,kube-router]\n############################\n# ------------------------------------------- flannel\n# [flannel]设置flannel 后端"host-gw","vxlan"等\nFLANNEL_BACKEND: "vxlan"\nDIRECT_ROUTING: false\n\n# [flannel] flanneld_image: "quay.io/coreos/flannel:v0.10.0-amd64"\nflannelVer: "v0.13.0-amd64"\nflanneld_image: "easzlab/flannel:{{ flannelVer }}"\n\n# [flannel]离线镜像tar包\nflannel_offline: "flannel_{{ flannelVer }}.tar"\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br")])]),s("p",[s("code",[n._v("vim /opt/kube/kube-system/flannel.yaml")])]),n._v(" "),s("h2",{attrs:{id:"_3、fannel的通信模型分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3、fannel的通信模型分析"}},[n._v("#")]),n._v(" 3、fannel的通信模型分析")]),n._v(" "),s("p",[s("strong",[n._v("进入node-1 pod")])]),n._v(" "),s("p",[s("code",[n._v("kubectl exec -it busy-deployment-558fbbb8b8-6pc22 sh")]),n._v(" #进入node-1的pod")]),n._v(" "),s("p",[n._v("查看网卡信息")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue qlen 1\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n3: eth0@if19: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1450 qdisc noqueue \n    link/ether 6a:99:37:6d:48:78 brd ff:ff:ff:ff:ff:ff\n    inet 172.20.1.27/24 brd 172.20.1.255 scope global eth0\n       valid_lft forever preferred_lft forever\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br")])]),s("p",[s("strong",[n._v("进入node-1 pod路由信息")])]),n._v(" "),s("p",[s("code",[n._v("route -n")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("Kernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         172.20.1.1      0.0.0.0         UG    0      0        0 eth0\n172.20.0.0      172.20.1.1      255.255.0.0     UG    0      0        0 eth0\n172.20.1.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br")])]),s("p",[s("strong",[n._v("查看node-1路由信息")])]),n._v(" "),s("p",[s("code",[n._v("route -n")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("0.0.0.0         192.168.2.1     0.0.0.0         UG    0      0        0 ens33\n172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0\n172.20.0.0      172.20.0.0      255.255.255.0   UG    0      0        0 flannel.1\n172.20.1.0      0.0.0.0         255.255.255.0   U     0      0        0 cni0\n172.20.2.0      172.20.2.0      255.255.255.0   UG    0      0        0 flannel.1\n172.20.3.0      172.20.3.0      255.255.255.0   UG    0      0        0 flannel.1\n192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 ens33\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br")])]),s("p",[s("strong",[n._v("查看node-1桥接信息")])]),n._v(" "),s("p",[s("code",[n._v("brctl show")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("bridge name     bridge id               STP enabled     interfaces\ncni0            8000.f257caf0a99c       no              veth267a77e9\n                                                        vethe20ace3f\ndocker0         8000.0242b7a9d354       no             \n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br")])]),s("h3",{attrs:{id:"_3-1、flannl-vxlan模式不同pod通信流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1、flannl-vxlan模式不同pod通信流程"}},[n._v("#")]),n._v(" 3-1、flannl-vxlan模式不同pod通信流程")]),n._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210905161744528.png",alt:"image-20210905161744528"}})]),n._v(" "),s("ol",[s("li",[n._v("pod 产生数据 基本都会往cni0发送")]),n._v(" "),s("li",[n._v("node主机上隧道设备flannel")]),n._v(" "),s("li",[n._v("flannel 查看目的ip 获取对端必要信息封装数据包")]),n._v(" "),s("li",[n._v("flannel 发送数据包到对端设备，对端网卡接受数据包")]),n._v(" "),s("li",[n._v("对端node 发现为overlay数据包，解开移除封装，发送到flannel")]),n._v(" "),s("li",[n._v("flannel 查看数据包 根据路由表匹配 ，数据发送cni0设备")]),n._v(" "),s("li",[n._v("cni0匹配路由表发送给对应网桥的端口（pod）")])]),n._v(" "),s("h3",{attrs:{id:"_3-2、flannl-vxlan-dirextrouting模式不同pod通信流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2、flannl-vxlan-dirextrouting模式不同pod通信流程"}},[n._v("#")]),n._v(" 3-2、flannl-vxlan-Dirextrouting模式不同pod通信流程")]),n._v(" "),s("p",[s("code",[n._v("ip route show")]),n._v(" #可以看出下一跳直接为ens33")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("default via 192.168.2.1 dev ens33 onlink \n172.17.0.0/16 dev docker0  proto kernel  scope link  src 172.17.0.1 linkdown \n172.20.0.0/24 via 192.168.2.26 dev ens33 \n172.20.1.0/24 dev cni0  proto kernel  scope link  src 172.20.1.1 \n172.20.2.0/24 via 192.168.2.23 dev ens33 \n172.20.3.0/24 via 192.168.2.22 dev ens33 \n192.168.2.0/24 dev ens33  proto kernel  scope link  src 192.168.2.25 \n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br")])]),s("p",[s("code",[n._v("tcpdump -i flannel.1 -nn icmp")]),n._v("#不再经过flannel端口")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("tcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on flannel.1, link-type EN10MB (Ethernet), capture size 262144 bytes\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("ol",[s("li",[n._v("pod 产生数据 基本都会往cni0发送")]),n._v(" "),s("li",[n._v("node主机上 直接通过路由表在宿主机端口发送")]),n._v(" "),s("li",[n._v("对端node主机通过宿主机端口接受")]),n._v(" "),s("li",[n._v("cni0匹配路由表发送给对应网桥的端口（pod）")])]),n._v(" "),s("h3",{attrs:{id:"_3-3、host-gw"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3、host-gw"}},[n._v("#")]),n._v(" 3-3、host-gw")]),n._v(" "),s("p",[n._v("host-gw：Host Gateway #不推荐，只能在二层网络中，不支持跨网络，如果有成千上万的Pod，容易产生广播风暴")]),n._v(" "),s("p",[n._v("与flannl-vxlan-Dirextrouting模式通信一样")]),n._v(" "),s("h2",{attrs:{id:"_4、kubeasz3更新vxlan-direct-routing"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4、kubeasz3更新vxlan-direct-routing"}},[n._v("#")]),n._v(" 4、kubeasz3更新VXLAN-DIRECT_ROUTING")]),n._v(" "),s("p",[s("code",[n._v("vim /etc/kubeasz/clusters/k8s-01/config.yml")]),n._v(" #主体配置文件")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('FLANNEL_BACKEND: "vxlan"\nDIRECT_ROUTING: true\n# 修改此处\nflannelVer: "v0.13.0-amd64"\nflanneld_image: "easzlab/flannel:{{ flannelVer }}"\nflannel_offline: "flannel_{{ flannelVer }}.tar"\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br")])]),s("p",[s("strong",[n._v("执行更新")])]),n._v(" "),s("p",[s("code",[n._v('ansible-playbook -i "clusters/k8s-01/hosts" -e "@clusters/k8s-01/config.yml" "playbooks/06.network.yml"')])]),n._v(" "),s("p",[s("code",[n._v("kubectl get configmap kube-flannel-cfg -o json -n kube-system")]),n._v("#查看配置")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('"net-conf.json": "{\\n  \\"Network\\": \\"172.20.0.0/16\\",\\n  \\"Backend\\": {\\n    \\"DirectRouting\\": true,\\n    \\"Type\\": \\"vxlan\\"\\n  }\\n}\\n"\n# 出现"DirectRouting\\": true\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("p",[s("code",[n._v("traceroute 172.20.0.21")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("traceroute to 172.20.0.21 (172.20.0.21), 30 hops max, 46 byte packets\n 1  172.20.1.1 (172.20.1.1)  0.005 ms  0.005 ms  0.004 ms\n 2  172.20.0.0 (172.20.0.0)  0.430 ms  0.410 ms  0.201 ms\n 3  172.20.0.21 (172.20.0.21)  0.331 ms  0.243 ms  0.306 ms\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br")])]),s("h2",{attrs:{id:"_5、注意"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5、注意"}},[n._v("#")]),n._v(" 5、注意")]),n._v(" "),s("p",[n._v("注意：flannel路由表丢失问题")]),n._v(" "),s("p",[n._v("重启网卡，flannel添加的这样静态路由会全部消失，导致pod之间网络异常")])])}),[],!1,null,null,null);e.default=l.exports}}]);