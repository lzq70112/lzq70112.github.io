(window.webpackJsonp=window.webpackJsonp||[]).push([[152],{622:function(s,a,t){"use strict";t.r(a);var n=t(20),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("K8S-gitlab+jenkins部署和回滚")]),s._v(" "),t("h2",{attrs:{id:"_1、基础环境jenkins与gitlab的互通"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、基础环境jenkins与gitlab的互通"}},[s._v("#")]),s._v(" 1、基础环境jenkins与gitlab的互通")]),s._v(" "),t("h3",{attrs:{id:"_1-1、jenkins-对gitlab-ssh-key"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1、jenkins-对gitlab-ssh-key"}},[s._v("#")]),s._v(" 1.1、jenkins 对gitlab ssh-key")]),s._v(" "),t("p",[s._v("jenkins执行")]),s._v(" "),t("p",[t("code",[s._v("cat ~/.ssh/id_rsa.pub")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919203328873.png",alt:"image-20210919203328873"}})]),s._v(" "),t("h3",{attrs:{id:"_1-2、gitlab的token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2、gitlab的token"}},[s._v("#")]),s._v(" 1.2、gitlab的token")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919211108742.png",alt:"image-20210919211108742"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919211214653.png",alt:"image-20210919211214653"}})]),s._v(" "),t("h3",{attrs:{id:"_1-3、jenkins-添加gitlab的token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3、jenkins-添加gitlab的token"}},[s._v("#")]),s._v(" 1.3、jenkins 添加gitlab的token")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919211512783.png",alt:"image-20210919211512783"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919211908243.png",alt:"image-20210919211908243"}})]),s._v(" "),t("p",[t("strong",[s._v("jenkins添加APItoken")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919212013568.png",alt:"image-20210919212013568"}})]),s._v(" "),t("h2",{attrs:{id:"_2、jenkins拉取gitlab项目参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、jenkins拉取gitlab项目参数"}},[s._v("#")]),s._v(" 2、jenkins拉取gitlab项目参数")]),s._v(" "),t("h3",{attrs:{id:"_2-1、创建项目并设置参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1、创建项目并设置参数"}},[s._v("#")]),s._v(" 2.1、创建项目并设置参数")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919160032487.png",alt:"image-20210919160032487"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919160405920.png",alt:"image-20210919160405920"}})]),s._v(" "),t("h3",{attrs:{id:"_2-2、执行shell脚本传参"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2、执行shell脚本传参"}},[s._v("#")]),s._v(" 2.2、执行shell脚本传参")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919160503405.png",alt:"image-20210919160503405"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919160637406.png",alt:"image-20210919160637406"}})]),s._v(" "),t("h3",{attrs:{id:"_2-3、脚本调用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3、脚本调用"}},[s._v("#")]),s._v(" 2.3、脚本调用")]),s._v(" "),t("p",[t("code",[s._v("bash cicd.sh")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gitlab的项目地址")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("URL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("git@192.168.2.220:root/nginx.git\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部署在那个K8S")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("k8s_master")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root@192.168.2.22"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务名称")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("project_name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# k8s命名空间")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ns")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# harbor的地址")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("harbor_prefix")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"my.harbor.com/base/"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# k8s项目名称")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("k8s_project")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"33"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gitlab下载本地地址")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DATA_DIR")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data/'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_project}")]),s._v('/gitdata/"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#################################################################")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认变量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# k8s 构建镜像的路径")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("k8s_dockerfile")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data/dockerfile/'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_project}")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# k8s 部署pod的路径")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("k8s_yaml")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data/yml/'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_project}")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 打包路径")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GIT_DIR")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DATA_DIR}")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开始时间")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Starttime")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%Y-%m-%d_%H-%M-%S"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部署方式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Method")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分支")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Branch")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 时间戳")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("t1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%Y-%m-%d %H:%M:%S"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" -z "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Branch")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Branch")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("develop\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#代码克隆至jenkins后端")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("clone_code")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -pv  "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATA_DIR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATA_DIR")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"开始清理上版本的文件"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -fr "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"开始在分支'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Branch")]),s._v('获取代码"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone -b "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Branch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${URL}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Clone Finished"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#代码打包压缩并远程推送至k8s_master-1的$project_name镜像制作目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("Pack_scp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATA_DIR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" cvzf "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v(".tar.gz * "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" Package Finished\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"开始打包到'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_master}")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_dockerfile}")]),s._v('/"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v(".tar.gz "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_master}")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_dockerfile}")]),s._v("/ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$k8s_master")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cd '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_dockerfile}")]),s._v("/ && tar xvf "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v(".tar.gz && rm -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v('.tar.gz"')]),s._v("\n    \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#远程操作k8s_master-1节点，进行镜像制作并推送至harbor镜像仓库")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("build_iamge")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$k8s_master")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cd '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_dockerfile}")]),s._v("/ && ./build-command.sh "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${Starttime}")]),s._v(" && echo 'build_image and push_harbor success!'\"")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#对k8s集群中的$project_name的pod应用进行升级")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("app_update")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$k8s_master")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"sed -ri 's@image: .*@image: "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${harbor_prefix}")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${Starttime}")]),s._v("@g'  "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_yaml}")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v('.yaml"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$k8s_master")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cp '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_yaml}")]),s._v("/*.yaml "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_yaml}")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v("-"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${Starttime}")]),s._v('.yaml.back"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$k8s_master")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubectl apply -f '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${k8s_yaml}")]),s._v('/*.yaml --record=true"')]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("t2")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%Y-%m-%d %H:%M:%S"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("start_T")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" --date"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${t1}")]),s._v('"')]),s._v(" +%s"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("end_T")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" --date"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${t2}")]),s._v('"')]),s._v(" +%s"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("total_time")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$((")]),s._v("end_T"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("start_T"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("))")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deploy success,it has been spent '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${total_time}")]),s._v(' seconds"')]),s._v("   \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#k8s集群中的pod应用进行回滚")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("app_rollback")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$k8s_master")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubectl rollout undo deployment/'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${project_name}")]),s._v("-deployment -n "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ns}")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\na\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#进行k8s集群自动部署的主函数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$Method")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" \n    deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        clone_code\n        Pack_scp\n        build_iamge\n        app_update\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    rollback"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        app_rollback\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("esac")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#执行主函数命令")]),s._v("\nmain "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$2")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br"),t("span",{staticClass:"line-number"},[s._v("77")]),t("br"),t("span",{staticClass:"line-number"},[s._v("78")]),t("br"),t("span",{staticClass:"line-number"},[s._v("79")]),t("br"),t("span",{staticClass:"line-number"},[s._v("80")]),t("br"),t("span",{staticClass:"line-number"},[s._v("81")]),t("br"),t("span",{staticClass:"line-number"},[s._v("82")]),t("br"),t("span",{staticClass:"line-number"},[s._v("83")]),t("br"),t("span",{staticClass:"line-number"},[s._v("84")]),t("br"),t("span",{staticClass:"line-number"},[s._v("85")]),t("br"),t("span",{staticClass:"line-number"},[s._v("86")]),t("br"),t("span",{staticClass:"line-number"},[s._v("87")]),t("br"),t("span",{staticClass:"line-number"},[s._v("88")]),t("br"),t("span",{staticClass:"line-number"},[s._v("89")]),t("br"),t("span",{staticClass:"line-number"},[s._v("90")]),t("br"),t("span",{staticClass:"line-number"},[s._v("91")]),t("br"),t("span",{staticClass:"line-number"},[s._v("92")]),t("br"),t("span",{staticClass:"line-number"},[s._v("93")]),t("br")])]),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("root@jenkins:/data/33/nginx# tree /data\n/data\n└── 33\n    ├── gitdata\n    │   ├── nginx\n    │   │   └── index.html\n    │   └── nginx.tar.gz\n    └── nginx\n        └── cicd.sh\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h2",{attrs:{id:"_3、gitlab创建项目"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、gitlab创建项目"}},[s._v("#")]),s._v(" 3、gitlab创建项目")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919201437189.png",alt:"image-20210919201437189"}})]),s._v(" "),t("h3",{attrs:{id:"_3-1、gitlab创建分支"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1、gitlab创建分支"}},[s._v("#")]),s._v(" 3.1、gitlab创建分支")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919203631684.png",alt:"image-20210919203631684"}})]),s._v(" "),t("h2",{attrs:{id:"_4、k8s的自动部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、k8s的自动部署"}},[s._v("#")]),s._v(" 4、K8S的自动部署")]),s._v(" "),t("h3",{attrs:{id:"_4-1、项目结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1、项目结构"}},[s._v("#")]),s._v(" 4.1、项目结构")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("root@master-1:/data/yml/33/nginx# tree /data/\n/data/\n├── dockerfile\n│   └── 33\n│       └── nginx\n│           ├── build-command.sh\n│           ├── Dockerfile\n│           ├── nginx\n│           │   └── index.html\n│           └── nginx.conf\n└── yml\n    └── 33\n        └── nginx\n            ├── nginx-2021-09-19_23-06-13.yaml.back\n            ├── nginx.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[t("code",[s._v("vim Dockfile")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('#Nginx Base Image\nFROM my.harbor.com/base/nginx-base:v1.14.2\nCMD rm -fr /usr/share/nginx/html/*\nADD nginx/* /usr/share/nginx/html/\nEXPOSE 80 443\nCMD ["nginx"]\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[t("code",[s._v("vim build-command.sh")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("#!/bin/bash\nTAG=$1\ndocker build -t my.harbor.com/base/nginx:${TAG} .\nsleep 1\ndocker push  my.harbor.com/base/nginx:${TAG}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"_4-2、构建测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2、构建测试"}},[s._v("#")]),s._v(" 4.2、构建测试")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919232104750.png",alt:"image-20210919232104750"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919232337718.png",alt:"image-20210919232337718"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210919232606536.png",alt:"image-20210919232606536"}})]),s._v(" "),t("h3",{attrs:{id:"_4-3、k8s输出"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3、k8s输出"}},[s._v("#")]),s._v(" 4.3、K8S输出")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210920093343634.png",alt:"image-20210920093343634"}})]),s._v(" "),t("h2",{attrs:{id:"_5、-gitlab版本更新测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5、-gitlab版本更新测试"}},[s._v("#")]),s._v(" 5、 gitlab版本更新测试")]),s._v(" "),t("p",[s._v("将版本更新为v2")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('root@ubuntu:~/gitlab/nginx# echo "nginx v2" >index.html\nroot@ubuntu:~/gitlab/nginx# git add .\nroot@ubuntu:~/gitlab/nginx# git commit -m "nginx -v"\n[master 9a57a83] nginx -v\n 1 file changed, 1 insertion(+), 1 deletion(-)\nroot@ubuntu:~/gitlab/nginx# git push origin master\nCounting objects: 3, done.\nWriting objects: 100% (3/3), 250 bytes | 0 bytes/s, done.\nTotal 3 (delta 0), reused 0 (delta 0)\nTo git@192.168.2.220:root/nginx.git\n   a4a06cd..9a57a83  master -> master\nroot@ubuntu:~/gitlab/nginx# \n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210920100428162.png",alt:"image-20210920100428162"}})]),s._v(" "),t("h2",{attrs:{id:"_6、回滚测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6、回滚测试"}},[s._v("#")]),s._v(" 6、回滚测试")]),s._v(" "),t("p",[t("strong",[s._v("将v2 升级v3 ，最后回滚")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210920101916338.png",alt:"image-20210920101916338"}})]),s._v(" "),t("p",[t("strong",[s._v("gitlab上传v3版本并构建")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210920102004753.png",alt:"image-20210920102004753"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210920102114215.png",alt:"image-20210920102114215"}})]),s._v(" "),t("p",[t("strong",[s._v("回滚")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210920102154896.png",alt:"image-20210920102154896"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210920102234875.png",alt:"image-20210920102234875"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);