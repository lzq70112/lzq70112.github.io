(window.webpackJsonp=window.webpackJsonp||[]).push([[105],{573:function(e,s,t){"use strict";t.r(s);var a=t(20),n=Object(a.a)({},(function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("kubeasz3部署etcd篇"),t("br")]),e._v(" "),t("h2",{attrs:{id:"_1、原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、原理"}},[e._v("#")]),e._v(" 1、原理")]),e._v(" "),t("p",[t("strong",[e._v("etcd")]),e._v("是一种高度一致的分布式键值存储，它提供了一种可靠的方式来存储需要由分布式系统或机器集群访问的数据。它在网络分区期间优雅地处理领导者选举，并且可以容忍机器故障，即使在领导节点中也是如此")]),e._v(" "),t("p",[e._v("使用标准 HTTP 工具（例如 curl）读取和写入值")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/interface.svg",alt:"简单的界面功能图标"}})]),e._v(" "),t("p",[e._v("将数据存储在分层组织的目录中，就像在标准文件系统中一样")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/kv.svg",alt:"键值存储功能图标"}})]),e._v(" "),t("p",[e._v("观察特定键或目录的变化并对值的变化做出反应")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/watch.svg",alt:"注意更改功能图标"}})]),e._v(" "),t("p",[t("a",{attrs:{href:"https://etcd.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("官方连接"),t("OutboundLink")],1)]),e._v(" "),t("h2",{attrs:{id:"_2、kubeasz3部署etcd配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、kubeasz3部署etcd配置"}},[e._v("#")]),e._v(" 2、kubeasz3部署etcd配置")]),e._v(" "),t("p",[e._v("kubeasz3部署etcd配置、最好分别部署在K8S集群之外")]),e._v(" "),t("p",[t("code",[e._v("vim /etc/kubeasz/clusters/k8s-01/hosts")])]),e._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".2.22\n"),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".2.23\n"),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("192.168")]),e._v(".2.25\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br")])]),t("h2",{attrs:{id:"_3、etcd配置正删改查"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、etcd配置正删改查"}},[e._v("#")]),e._v(" 3、etcd配置正删改查")]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=3 etcdctl get / --prefix --keys-only | grep flannel")]),e._v(" #查看所有key")]),e._v(" "),t("p",[t("strong",[e._v("增加")])]),e._v(" "),t("p",[t("code",[e._v('ETCDCTL_API=3 etcdctl put /xiongmao "henshuai"')])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("OK\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[t("strong",[e._v("删除")])]),e._v(" "),t("p",[t("code",[e._v('ETCDCTL_API=3 etcdctl get /xiongmao "henshuai"')])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("/xiongmao\nhenshuai\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br")])]),t("p",[t("strong",[e._v("修改")])]),e._v(" "),t("p",[t("code",[e._v('ETCDCTL_API=3 etcdctl put /xiongmao "chaojishuai"')])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("OK\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[t("code",[e._v("ETCDCTL_API=3 etcdctl get /xiongmao")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("/xiongmao\nchaojishuai\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br")])]),t("p",[t("strong",[e._v("删除")])]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=3 etcdctl del /xiongmao")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("1\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[t("strong",[e._v("删除功能应用")])]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=3 etcdctl get / --prefix --keys-only | grep deployment")]),e._v(" #查看应用deployment")]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=3 etcdctl get / --prefix --keys-only | grep service")]),e._v("#查看svc")]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=3 etcdctl del /registry/deployments/default/nginx-deployment")]),e._v("#删除deployment")]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=3 etcdctl del /registry/services/specs/default/ngx-service #删除svc")])]),e._v(" "),t("p",[t("code",[e._v("kubectl get pods")]),e._v("#查看pod状态")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("NAME                              READY   STATUS        RESTARTS   AGE\nnginx-deployment-fbbdf7c9-dhpjk   0/1     Terminating   0          9m7s\nnginx-deployment-fbbdf7c9-jnrh7   0/1     Terminating   0          9m7s\nnginx-deployment-fbbdf7c9-kcvmm   1/1     Terminating   0          9m7s\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br")])]),t("h2",{attrs:{id:"_4、etc集群配健康查看"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、etc集群配健康查看"}},[e._v("#")]),e._v(" 4、etc集群配健康查看")]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=3 /etc/ansible/bin/etcdctl --write-out=table --cacert=/etc/kubernetes/ssl/ca.pem --cert=/etc/kubernetes/ssl/etcd.pem --key=/etc/kubernetes/ssl/etcd-key.pem --endpoints=https://192.168.2.22:2379,https://192.168.2.23:2379,https://192.168.2.25:2379 endpoint health")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("+---------------------------+--------+-------------+-------+\n|         ENDPOINT          | HEALTH |    TOOK     | ERROR |\n+---------------------------+--------+-------------+-------+\n| https://192.168.2.23:2379 |   true | 19.449987ms |       |\n| https://192.168.2.22:2379 |   true | 17.518267ms |       |\n| https://192.168.2.25:2379 |   true | 16.623784ms |       |\n+---------------------------+--------+-------------+-------+\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br")])]),t("h2",{attrs:{id:"_5、etc的watch机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5、etc的watch机制"}},[e._v("#")]),e._v(" 5、etc的watch机制")]),e._v(" "),t("p",[t("strong",[e._v("etcd1 watch查看数据")])]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=3 etcdctl watch /xiongmao")])]),e._v(" "),t("p",[t("strong",[e._v("etcd2测试")])]),e._v(" "),t("p",[t("code",[e._v('ETCDCTL_API=3 etcdctl put /xiongmao "dashuaibi"')])]),e._v(" "),t("p",[t("strong",[e._v("etcd1查看变化")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("PUT\n/xiongmao\ndashuaibi\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br")])]),t("h2",{attrs:{id:"_6、etc的备份还原"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6、etc的备份还原"}},[e._v("#")]),e._v(" 6、etc的备份还原")]),e._v(" "),t("h3",{attrs:{id:"_6-1、v2备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1、v2备份"}},[e._v("#")]),e._v(" 6-1、v2备份")]),e._v(" "),t("p",[t("strong",[e._v("备份")])]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=2 etcdctl backup --data-dir /var/lib/etcd/ --backup-dir /opt/backdir")])]),e._v(" "),t("p",[t("strong",[e._v("恢复")])]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=2 etcdctl --data-dir /var/lib/etcd/default.etcd --force-new-cluster $")])]),e._v(" "),t("p",[t("code",[e._v("vim /etc/systemd/system/etcd.service")]),e._v(" #修改启动")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("--data-dir=/var/lib/etcd \\\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h3",{attrs:{id:"_6-2、v3备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-2、v3备份"}},[e._v("#")]),e._v(" 6-2、v3备份")]),e._v(" "),t("p",[t("strong",[e._v("备份")])]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=3 etcdctl snapshot save xiongmao.db")])]),e._v(" "),t("p",[t("strong",[e._v("还原")])]),e._v(" "),t("p",[t("code",[e._v("ETCDCTL_API=3 etcdctl snapshot restore snapshot.db")])]),e._v(" "),t("p",[t("strong",[e._v("备份脚本")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('#!/bin/bash\nset -e\nexec >> /var/log/backup_etcd.log\n\nDate=`date +%Y-%m-%d-%H-%M`\nEtcdEndpoints="localhost:2379"\nEtcdCmd="/usr/bin/etcdctl"\nBackupDir="/home/www/server/backup/etcd"\nBackupFile="snapshot.db.$Date"\n\necho "`date` backup etcd..."\n\nexport ETCDCTL_API=3\n$EtcdCmd --endpoints $EtcdEndpoints snapshot save  $BackupDir/$BackupFile\n\necho  "`date` backup done!"\n')])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br"),t("span",{staticClass:"line-number"},[e._v("13")]),t("br"),t("span",{staticClass:"line-number"},[e._v("14")]),t("br"),t("span",{staticClass:"line-number"},[e._v("15")]),t("br"),t("span",{staticClass:"line-number"},[e._v("16")]),t("br")])]),t("p",[t("code",[e._v("etcdctl snapshot restore snapshot.db.2019-05-21-10-02 --data-dir /home/www/server/etcd")])]),e._v(" "),t("h3",{attrs:{id:"_6-3、kubeasz3的ansible备份etcd-v3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-3、kubeasz3的ansible备份etcd-v3"}},[e._v("#")]),e._v(" 6-3、kubeasz3的ansible备份etcd-v3")]),e._v(" "),t("p",[t("code",[e._v("cd /etc/kubeasz/playbooks")])]),e._v(" "),t("p",[t("code",[e._v("ansible-playbook 94.backup.yml")])]),e._v(" "),t("p",[t("code",[e._v("ansible-playbook 95.restore.yml")])])])}),[],!1,null,null,null);s.default=n.exports}}]);