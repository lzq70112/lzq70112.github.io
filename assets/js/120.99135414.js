(window.webpackJsonp=window.webpackJsonp||[]).push([[120],{590:function(n,s,e){"use strict";e.r(s);var a=e(20),t=Object(a.a)({},(function(){var n=this,s=n.$createElement,e=n._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[e("p",[n._v("K8S标签、回滚及ectd删除资源")]),n._v(" "),e("h2",{attrs:{id:"_1、修改node标签"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1、修改node标签"}},[n._v("#")]),n._v(" 1、修改node标签")]),n._v(" "),e("p",[e("code",[n._v("kubectl label node 192.168.2.25 project=nginx")])]),n._v(" "),e("p",[e("code",[n._v("kubectl describe node 192.168.2.25")]),n._v("#查看标签")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("Name:               192.168.2.25\nRoles:              node\nLabels:             beta.kubernetes.io/arch=amd64\n                    beta.kubernetes.io/os=linux\n                    kubernetes.io/arch=amd64\n                    kubernetes.io/hostname=192.168.2.25\n                    kubernetes.io/os=linux\n                    kubernetes.io/role=node\n                    project=nginx #标签\n\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br")])]),e("p",[e("strong",[n._v("再yaml应用标签")])]),n._v(" "),e("p",[e("code",[n._v("vim nginx-v2.xml")])]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('kind: Deployment\napiVersion: apps/v1\nmetadata:\n  labels:\n    app: nginx-deployment-label \n  name: nginx-deployment \n  namespace: nginx\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx-selector\n  template:\n    metadata:\n      labels:\n        app: nginx-selector\n    spec:\n      containers:\n      - name: nginx-container\n        image: my.harbor.com/webapp/nginx-web:v2\n        #imagePullPolicy: IfNotPresent\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 80\n          protocol: TCP\n          name: http\n        - containerPort: 443\n          protocol: TCP\n          name: https\n        env:\n        - name: "password"\n          value: "123456"\n        - name: "age"\n          value: "18"\n        resources:\n          limits:\n            cpu: 2\n            memory: 2Gi\n          requests:\n            cpu: 1\n            memory: 512Mi\n        volumeMounts:\n          - name: webapp\n            mountPath: /usr/local/nginx/html/webapp/images\n            readOnly: false\n          - name: static\n            mountPath: /usr/local/nginx/html/webapp/static\n            readOnly: false\n      volumes:\n      - name: webapp\n        nfs:\n          server: my.nfs.com\n          path: /data/webapp/images\n      - name: static\n        nfs: \n          server: my.nfs.com\n          path: /data/webapp/static \n      nodeSelector:\n        project: nginx\n        # 修改标签\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: nginx\n  name: nginx-spec\n  namespace: nginx\nspec:\n  type: NodePort\n  ports:\n  - name: http\n    port: 80\n    protocol: TCP\n    targetPort: 80\n    nodePort: 30002\n  - name: https\n    port: 443\n    protocol: TCP\n    targetPort: 443\n    nodePort: 30043\n  selector:\n    app: nginx-selector\n\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br"),e("span",{staticClass:"line-number"},[n._v("33")]),e("br"),e("span",{staticClass:"line-number"},[n._v("34")]),e("br"),e("span",{staticClass:"line-number"},[n._v("35")]),e("br"),e("span",{staticClass:"line-number"},[n._v("36")]),e("br"),e("span",{staticClass:"line-number"},[n._v("37")]),e("br"),e("span",{staticClass:"line-number"},[n._v("38")]),e("br"),e("span",{staticClass:"line-number"},[n._v("39")]),e("br"),e("span",{staticClass:"line-number"},[n._v("40")]),e("br"),e("span",{staticClass:"line-number"},[n._v("41")]),e("br"),e("span",{staticClass:"line-number"},[n._v("42")]),e("br"),e("span",{staticClass:"line-number"},[n._v("43")]),e("br"),e("span",{staticClass:"line-number"},[n._v("44")]),e("br"),e("span",{staticClass:"line-number"},[n._v("45")]),e("br"),e("span",{staticClass:"line-number"},[n._v("46")]),e("br"),e("span",{staticClass:"line-number"},[n._v("47")]),e("br"),e("span",{staticClass:"line-number"},[n._v("48")]),e("br"),e("span",{staticClass:"line-number"},[n._v("49")]),e("br"),e("span",{staticClass:"line-number"},[n._v("50")]),e("br"),e("span",{staticClass:"line-number"},[n._v("51")]),e("br"),e("span",{staticClass:"line-number"},[n._v("52")]),e("br"),e("span",{staticClass:"line-number"},[n._v("53")]),e("br"),e("span",{staticClass:"line-number"},[n._v("54")]),e("br"),e("span",{staticClass:"line-number"},[n._v("55")]),e("br"),e("span",{staticClass:"line-number"},[n._v("56")]),e("br"),e("span",{staticClass:"line-number"},[n._v("57")]),e("br"),e("span",{staticClass:"line-number"},[n._v("58")]),e("br"),e("span",{staticClass:"line-number"},[n._v("59")]),e("br"),e("span",{staticClass:"line-number"},[n._v("60")]),e("br"),e("span",{staticClass:"line-number"},[n._v("61")]),e("br"),e("span",{staticClass:"line-number"},[n._v("62")]),e("br"),e("span",{staticClass:"line-number"},[n._v("63")]),e("br"),e("span",{staticClass:"line-number"},[n._v("64")]),e("br"),e("span",{staticClass:"line-number"},[n._v("65")]),e("br"),e("span",{staticClass:"line-number"},[n._v("66")]),e("br"),e("span",{staticClass:"line-number"},[n._v("67")]),e("br"),e("span",{staticClass:"line-number"},[n._v("68")]),e("br"),e("span",{staticClass:"line-number"},[n._v("69")]),e("br"),e("span",{staticClass:"line-number"},[n._v("70")]),e("br"),e("span",{staticClass:"line-number"},[n._v("71")]),e("br"),e("span",{staticClass:"line-number"},[n._v("72")]),e("br"),e("span",{staticClass:"line-number"},[n._v("73")]),e("br"),e("span",{staticClass:"line-number"},[n._v("74")]),e("br"),e("span",{staticClass:"line-number"},[n._v("75")]),e("br"),e("span",{staticClass:"line-number"},[n._v("76")]),e("br"),e("span",{staticClass:"line-number"},[n._v("77")]),e("br"),e("span",{staticClass:"line-number"},[n._v("78")]),e("br"),e("span",{staticClass:"line-number"},[n._v("79")]),e("br"),e("span",{staticClass:"line-number"},[n._v("80")]),e("br"),e("span",{staticClass:"line-number"},[n._v("81")]),e("br"),e("span",{staticClass:"line-number"},[n._v("82")]),e("br"),e("span",{staticClass:"line-number"},[n._v("83")]),e("br"),e("span",{staticClass:"line-number"},[n._v("84")]),e("br")])]),e("p",[e("code",[n._v("kubectl get pod -n nginx -o wide")]),n._v(" #可以看到已经重新调度到192.168.2.25节点上")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("NAME                                            READY   STATUS        RESTARTS   AGE   IP              NODE           NOMINATED NODE   READINESS GATES\nnginx-deployment-56b8bd599-c9vfp                1/1     Running       0          20s   172.20.84.172   192.168.2.25   <none>           <none>\nnginx-deployment-56b8bd599-pfqvm                1/1     Running       0          18s   172.20.84.174   192.168.2.25   <none>           <none>\nnginx-deployment-5bd9b86487-z4l8c               0/1     Terminating   0          37h   172.20.247.23   192.168.2.26   <none>           <none>\ntomcat-app1-deployment-label-55794bfcf7-4njn4   1/1     Running       0          38h   172.20.247.21   192.168.2.26   <none>           <none>\ntomcat-app1-deployment-label-55794bfcf7-ccqdp   1/1     Running       0          35h   172.20.84.171   192.168.2.25   <none>           <none>\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br")])]),e("h2",{attrs:{id:"_2、通过kubectl-rallout回滚"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2、通过kubectl-rallout回滚"}},[n._v("#")]),n._v(" 2、通过kubectl rallout回滚")]),n._v(" "),e("p",[e("code",[n._v("kubectl get deployment -n nginx")]),n._v(" 查看deployment")]),n._v(" "),e("p",[e("code",[n._v("kubectl rollout history deployment tomcat-app1-deployment-label -n nginx")]),n._v("  #查看构件历史和版本")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("deployment.apps/tomcat-app1-deployment-label \nREVISION  CHANGE-CAUSE\n1         <none>\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br")])]),e("p",[e("code",[n._v("kubectl apply -f tomcat-appv2.yaml --record=true")]),n._v("  #对tomcat服务进行更新")]),n._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210908125042404.png",alt:"image-20210908125042404"}})]),n._v(" "),e("p",[e("code",[n._v("kubectl rollout history deployment tomcat-app1-deployment-label -n nginx")])]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("deployment.apps/tomcat-app1-deployment-label \nREVISION  CHANGE-CAUSE\n1         kubectl apply --filename=tomcat-app.yaml --record=true\n2         kubectl apply --filename=tomcat-appv2.yaml --record=true\n          #record记录history\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br")])]),e("h3",{attrs:{id:"_2-1、回滚到上一个版本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1、回滚到上一个版本"}},[n._v("#")]),n._v(" 2.1、回滚到上一个版本")]),n._v(" "),e("p",[e("code",[n._v("kubectl rollout undo deployment tomcat-app1-deployment-label -n nginx")]),n._v("#undo回滚上一个版本")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("deployment.apps/tomcat-app1-deployment-label rolled back\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210908125431916.png",alt:"k8s回滚"}})]),n._v(" "),e("h3",{attrs:{id:"_2-2、回滚到指定版本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2、回滚到指定版本"}},[n._v("#")]),n._v(" 2-2、回滚到指定版本")]),n._v(" "),e("p",[e("code",[n._v("kubectl rollout undo deployment tomcat-app1-deployment-label --to-revision=2 -n nginx")]),n._v("#undo回滚指定版本")]),n._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210908125042404.png",alt:"image-20210908125042404"}})]),n._v(" "),e("h3",{attrs:{id:"_2-3、升级镜像的方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3、升级镜像的方式"}},[n._v("#")]),n._v(" 2-3、升级镜像的方式")]),n._v(" "),e("p",[e("code",[n._v("kubectl set image deployment/tomcat-app1-deployment-label tomcat-app1-container=my.harbor.com/webapp/tomcat-app:v1 -n nginx")])]),n._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20210908125431916.png",alt:"k8s回滚"}})]),n._v(" "),e("h2",{attrs:{id:"_3、配置主机为封锁状态且不参与调度"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3、配置主机为封锁状态且不参与调度"}},[n._v("#")]),n._v(" 3、配置主机为封锁状态且不参与调度")]),n._v(" "),e("p",[n._v("不会将容器部署到节点")]),n._v(" "),e("p",[e("code",[n._v("kubectl cordon 192.168.2.22")])]),n._v(" "),e("p",[e("code",[n._v("kubectl cordon 192.168.2.23")])]),n._v(" "),e("p",[e("code",[n._v("kubectl get node")])]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("NAME           STATUS                     ROLES    AGE   VERSION\n192.168.2.22   Ready,SchedulingDisabled   master   18d   v1.20.2\n192.168.2.23   Ready,SchedulingDisabled   master   18d   v1.20.2\n192.168.2.25   Ready                      node     18d   v1.20.2\n192.168.2.26   Ready                      node     18d   v1.20.2\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br")])]),e("p",[e("code",[n._v("kubectl uncordon 192.168.2.23")]),n._v(" #调度")]),n._v(" "),e("h2",{attrs:{id:"_4、etcd删除pod"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4、etcd删除pod"}},[n._v("#")]),n._v(" 4、etcd删除pod")]),n._v(" "),e("p",[e("code",[n._v("etcdctl get /registry/ --prefix --keys-only | grep nginx")])]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("/registry/deployments/nginx/nginx-deployment\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br")])]),e("p",[e("code",[n._v("etcdctl del /registry/deployments/nginx/nginx-deployment")]),n._v(" #删除")])])}),[],!1,null,null,null);s.default=t.exports}}]);