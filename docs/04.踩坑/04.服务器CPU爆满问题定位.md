---
title: 服务器CPU爆满问题定位
date: 2020-04-23 18:18:21
permalink: /pages/3e2d38/
categories:
  - 踩坑
tags: 
  - linux
  - 踩坑
---

例如线上服务器CPU100%，如何找到相关服务，如何定位问题代码。

服务器上部署了若干tomcat实例，即若干垂直切分的Java站点服务，以及若干Java微服务，突然收到运维的CPU异常告警。

问：如何定位是哪个服务进程导致CPU过载，哪个线程导致CPU过载，哪段代码导致CPU过载？
<!-- more -->

## 找到最耗CPU的进程
- 执行top -c ，显示进程运行信息列表
- 键入P (大写p)，进程按照CPU使用率排序

例如这里得到的最耗CPU的进程PID为12345

## 找到最耗CPU的线程
- `top -Hp 12345` ，显示一个进程的线程运行信息列表 
- 键入P (大写p)，线程按照CPU使用率排序

例如进程12345内，最耗CPU的线程PID为67890

## 将线程PID转化为16进制

`printf "%x\n" 67890`,得到67890对应的16进制是10932

之所以要转化为16进制，是因为堆栈里，线程id是用16进制表示的。

## 查看堆栈，找到线程在干嘛
- 打印进程堆栈
- 通过线程id，过滤得到线程堆栈
`jstack 12345 | grep '10932' -C5 --color`