<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Prometheus之Operator安装及使用 | xiongmao&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="K8S、ELK、Jenkins、DevOps、CI/CD、Python、go、运维、运维开发、云原生、集群运维">
    <meta name="keywords" content="K8S、ELK、Jenkins、DevOps、CI/CD、Python、nginx、tomcat、mysql、ansible">
    <meta name="baidu-site-verification" content="b9w0xnx4YF">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.6732922a.css" as="style"><link rel="preload" href="/assets/js/app.e7221624.js" as="script"><link rel="preload" href="/assets/js/2.1e679d1d.js" as="script"><link rel="preload" href="/assets/js/171.8d1021c2.js" as="script"><link rel="prefetch" href="/assets/js/10.a711d5fc.js"><link rel="prefetch" href="/assets/js/100.24d6aa43.js"><link rel="prefetch" href="/assets/js/101.c117fc2a.js"><link rel="prefetch" href="/assets/js/102.6b262694.js"><link rel="prefetch" href="/assets/js/103.7bf86548.js"><link rel="prefetch" href="/assets/js/104.54770dc3.js"><link rel="prefetch" href="/assets/js/105.f9af743e.js"><link rel="prefetch" href="/assets/js/106.553f5ef8.js"><link rel="prefetch" href="/assets/js/107.265aceab.js"><link rel="prefetch" href="/assets/js/108.f20abc28.js"><link rel="prefetch" href="/assets/js/109.a27e2a34.js"><link rel="prefetch" href="/assets/js/11.a6dae5da.js"><link rel="prefetch" href="/assets/js/110.c922f6fd.js"><link rel="prefetch" href="/assets/js/111.4fa6852b.js"><link rel="prefetch" href="/assets/js/112.5e0c1c97.js"><link rel="prefetch" href="/assets/js/113.5af907d8.js"><link rel="prefetch" href="/assets/js/114.20f5b2ef.js"><link rel="prefetch" href="/assets/js/115.e9ed1b7d.js"><link rel="prefetch" href="/assets/js/116.87448a71.js"><link rel="prefetch" href="/assets/js/117.664f9e24.js"><link rel="prefetch" href="/assets/js/118.c3ad91dc.js"><link rel="prefetch" href="/assets/js/119.fea33d99.js"><link rel="prefetch" href="/assets/js/12.5e6cb236.js"><link rel="prefetch" href="/assets/js/120.99135414.js"><link rel="prefetch" href="/assets/js/121.67431f42.js"><link rel="prefetch" href="/assets/js/122.e5b201e1.js"><link rel="prefetch" href="/assets/js/123.56a8519c.js"><link rel="prefetch" href="/assets/js/124.f46051c7.js"><link rel="prefetch" href="/assets/js/125.d1426c10.js"><link rel="prefetch" href="/assets/js/126.935ac184.js"><link rel="prefetch" href="/assets/js/127.96e995ee.js"><link rel="prefetch" href="/assets/js/128.25122e8b.js"><link rel="prefetch" href="/assets/js/129.d920ab03.js"><link rel="prefetch" href="/assets/js/13.8fb916dd.js"><link rel="prefetch" href="/assets/js/130.f22667b3.js"><link rel="prefetch" href="/assets/js/131.767ff4bc.js"><link rel="prefetch" href="/assets/js/132.8d98b382.js"><link rel="prefetch" href="/assets/js/133.7d094f05.js"><link rel="prefetch" href="/assets/js/134.b0ceb6e3.js"><link rel="prefetch" href="/assets/js/135.f79e660b.js"><link rel="prefetch" href="/assets/js/136.953d769e.js"><link rel="prefetch" href="/assets/js/137.9d5802d2.js"><link rel="prefetch" href="/assets/js/138.8e02fa5c.js"><link rel="prefetch" href="/assets/js/139.b9e91678.js"><link rel="prefetch" href="/assets/js/14.bc1837be.js"><link rel="prefetch" href="/assets/js/140.4699c687.js"><link rel="prefetch" href="/assets/js/141.8eefbbaa.js"><link rel="prefetch" href="/assets/js/142.27d45adb.js"><link rel="prefetch" href="/assets/js/143.f6f923f7.js"><link rel="prefetch" href="/assets/js/144.f14a5230.js"><link rel="prefetch" href="/assets/js/145.2c25c568.js"><link rel="prefetch" href="/assets/js/146.788e90e0.js"><link rel="prefetch" href="/assets/js/147.b3120ee6.js"><link rel="prefetch" href="/assets/js/148.62b7c62a.js"><link rel="prefetch" href="/assets/js/149.a5c5ace4.js"><link rel="prefetch" href="/assets/js/15.bcde294a.js"><link rel="prefetch" href="/assets/js/150.86d0eb3a.js"><link rel="prefetch" href="/assets/js/151.b653d4ff.js"><link rel="prefetch" href="/assets/js/152.0eeee040.js"><link rel="prefetch" href="/assets/js/153.0b7a1da9.js"><link rel="prefetch" href="/assets/js/154.d80a7f08.js"><link rel="prefetch" href="/assets/js/155.4531d3d6.js"><link rel="prefetch" href="/assets/js/156.2f305049.js"><link rel="prefetch" href="/assets/js/157.d2a0fbc5.js"><link rel="prefetch" href="/assets/js/158.6a87dd62.js"><link rel="prefetch" href="/assets/js/159.ce0968fd.js"><link rel="prefetch" href="/assets/js/16.a96da137.js"><link rel="prefetch" href="/assets/js/160.f7508c8f.js"><link rel="prefetch" href="/assets/js/161.91b40a07.js"><link rel="prefetch" href="/assets/js/162.d066159e.js"><link rel="prefetch" href="/assets/js/163.ded50322.js"><link rel="prefetch" href="/assets/js/164.866bec3d.js"><link rel="prefetch" href="/assets/js/165.79580fd7.js"><link rel="prefetch" href="/assets/js/166.b76915c2.js"><link rel="prefetch" href="/assets/js/167.4122b048.js"><link rel="prefetch" href="/assets/js/168.2ade24d2.js"><link rel="prefetch" href="/assets/js/169.e4cf458b.js"><link rel="prefetch" href="/assets/js/17.329a0167.js"><link rel="prefetch" href="/assets/js/170.055e2f01.js"><link rel="prefetch" href="/assets/js/172.979e1d08.js"><link rel="prefetch" href="/assets/js/173.0e5667db.js"><link rel="prefetch" href="/assets/js/174.13df9b11.js"><link rel="prefetch" href="/assets/js/175.b0f8e245.js"><link rel="prefetch" href="/assets/js/176.8011865c.js"><link rel="prefetch" href="/assets/js/177.3c82b4a9.js"><link rel="prefetch" href="/assets/js/178.1427ffad.js"><link rel="prefetch" href="/assets/js/179.9e55fe39.js"><link rel="prefetch" href="/assets/js/18.048038df.js"><link rel="prefetch" href="/assets/js/180.1f316f88.js"><link rel="prefetch" href="/assets/js/181.830e98f1.js"><link rel="prefetch" href="/assets/js/182.807b4423.js"><link rel="prefetch" href="/assets/js/183.56e5d811.js"><link rel="prefetch" href="/assets/js/184.58165fc4.js"><link rel="prefetch" href="/assets/js/185.9eb4fb3e.js"><link rel="prefetch" href="/assets/js/186.801d2024.js"><link rel="prefetch" href="/assets/js/187.0767512b.js"><link rel="prefetch" href="/assets/js/188.860f9aa7.js"><link rel="prefetch" href="/assets/js/189.d849c1c4.js"><link rel="prefetch" href="/assets/js/19.674f919f.js"><link rel="prefetch" href="/assets/js/190.1daa10ee.js"><link rel="prefetch" href="/assets/js/191.467bba3f.js"><link rel="prefetch" href="/assets/js/192.841a56c3.js"><link rel="prefetch" href="/assets/js/193.89bcabec.js"><link rel="prefetch" href="/assets/js/194.e8ded807.js"><link rel="prefetch" href="/assets/js/195.3e7b0617.js"><link rel="prefetch" href="/assets/js/196.95f00ff1.js"><link rel="prefetch" href="/assets/js/197.76d38222.js"><link rel="prefetch" href="/assets/js/198.7e1912e1.js"><link rel="prefetch" href="/assets/js/199.8a7f294d.js"><link rel="prefetch" href="/assets/js/20.56b4d647.js"><link rel="prefetch" href="/assets/js/200.9b1ddc2a.js"><link rel="prefetch" href="/assets/js/201.291b74c8.js"><link rel="prefetch" href="/assets/js/202.15d119a4.js"><link rel="prefetch" href="/assets/js/203.d7d33e0b.js"><link rel="prefetch" href="/assets/js/204.e1ab1070.js"><link rel="prefetch" href="/assets/js/205.c391b268.js"><link rel="prefetch" href="/assets/js/206.bf3b2e92.js"><link rel="prefetch" href="/assets/js/207.754f6593.js"><link rel="prefetch" href="/assets/js/208.6fad6e05.js"><link rel="prefetch" href="/assets/js/209.4afd7509.js"><link rel="prefetch" href="/assets/js/21.60c8872f.js"><link rel="prefetch" href="/assets/js/210.4bd3dbe8.js"><link rel="prefetch" href="/assets/js/211.19a1b42c.js"><link rel="prefetch" href="/assets/js/212.57a1b8c5.js"><link rel="prefetch" href="/assets/js/213.bd4c5274.js"><link rel="prefetch" href="/assets/js/214.8921ec84.js"><link rel="prefetch" href="/assets/js/215.459b1d0e.js"><link rel="prefetch" href="/assets/js/216.aebd6bf1.js"><link rel="prefetch" href="/assets/js/217.dab1470b.js"><link rel="prefetch" href="/assets/js/218.6e059aec.js"><link rel="prefetch" href="/assets/js/219.72054a37.js"><link rel="prefetch" href="/assets/js/22.fdf97007.js"><link rel="prefetch" href="/assets/js/220.7184442c.js"><link rel="prefetch" href="/assets/js/221.afdbe6c1.js"><link rel="prefetch" href="/assets/js/222.eac2b252.js"><link rel="prefetch" href="/assets/js/223.4785e013.js"><link rel="prefetch" href="/assets/js/224.27358d52.js"><link rel="prefetch" href="/assets/js/225.0082a87e.js"><link rel="prefetch" href="/assets/js/226.a6a027b2.js"><link rel="prefetch" href="/assets/js/227.55b58d50.js"><link rel="prefetch" href="/assets/js/228.172efcf6.js"><link rel="prefetch" href="/assets/js/229.d534fb18.js"><link rel="prefetch" href="/assets/js/23.10a156cb.js"><link rel="prefetch" href="/assets/js/230.720d75bc.js"><link rel="prefetch" href="/assets/js/231.7bc7aa8f.js"><link rel="prefetch" href="/assets/js/232.3f9ab0c4.js"><link rel="prefetch" href="/assets/js/233.d74308ce.js"><link rel="prefetch" href="/assets/js/234.dd9ae057.js"><link rel="prefetch" href="/assets/js/235.ec785b6e.js"><link rel="prefetch" href="/assets/js/236.267e73c5.js"><link rel="prefetch" href="/assets/js/237.2e57b470.js"><link rel="prefetch" href="/assets/js/238.3f9da24a.js"><link rel="prefetch" href="/assets/js/239.e03ebe19.js"><link rel="prefetch" href="/assets/js/24.4e04c9e7.js"><link rel="prefetch" href="/assets/js/240.0d490de0.js"><link rel="prefetch" href="/assets/js/241.7505bfb6.js"><link rel="prefetch" href="/assets/js/242.137a5428.js"><link rel="prefetch" href="/assets/js/243.b8914177.js"><link rel="prefetch" href="/assets/js/244.da9e248f.js"><link rel="prefetch" href="/assets/js/245.28437df7.js"><link rel="prefetch" href="/assets/js/246.2c235016.js"><link rel="prefetch" href="/assets/js/247.52676c46.js"><link rel="prefetch" href="/assets/js/248.ece61318.js"><link rel="prefetch" href="/assets/js/249.ff7eccd2.js"><link rel="prefetch" href="/assets/js/25.e17374f9.js"><link rel="prefetch" href="/assets/js/250.dac20dcd.js"><link rel="prefetch" href="/assets/js/251.bc176c68.js"><link rel="prefetch" href="/assets/js/252.279835bc.js"><link rel="prefetch" href="/assets/js/253.7497ddda.js"><link rel="prefetch" href="/assets/js/254.95475930.js"><link rel="prefetch" href="/assets/js/255.02dc3505.js"><link rel="prefetch" href="/assets/js/256.a34c36ad.js"><link rel="prefetch" href="/assets/js/257.67ad6470.js"><link rel="prefetch" href="/assets/js/258.ea2b27b5.js"><link rel="prefetch" href="/assets/js/259.81209387.js"><link rel="prefetch" href="/assets/js/26.34503cad.js"><link rel="prefetch" href="/assets/js/260.024c3f3e.js"><link rel="prefetch" href="/assets/js/261.0df7357d.js"><link rel="prefetch" href="/assets/js/262.4e6da19e.js"><link rel="prefetch" href="/assets/js/263.28548e49.js"><link rel="prefetch" href="/assets/js/264.a711087c.js"><link rel="prefetch" href="/assets/js/265.45b7c9b8.js"><link rel="prefetch" href="/assets/js/266.65ee3594.js"><link rel="prefetch" href="/assets/js/267.4eeefd02.js"><link rel="prefetch" href="/assets/js/268.eb8fffe3.js"><link rel="prefetch" href="/assets/js/269.aa6a90b0.js"><link rel="prefetch" href="/assets/js/27.bd1f04ea.js"><link rel="prefetch" href="/assets/js/270.162a9089.js"><link rel="prefetch" href="/assets/js/271.fc29d223.js"><link rel="prefetch" href="/assets/js/272.0dda0be6.js"><link rel="prefetch" href="/assets/js/273.afc6b167.js"><link rel="prefetch" href="/assets/js/274.e7c546a6.js"><link rel="prefetch" href="/assets/js/275.b978f78e.js"><link rel="prefetch" href="/assets/js/276.43860563.js"><link rel="prefetch" href="/assets/js/277.f2150475.js"><link rel="prefetch" href="/assets/js/278.0941595a.js"><link rel="prefetch" href="/assets/js/279.d943f446.js"><link rel="prefetch" href="/assets/js/28.a709d8a8.js"><link rel="prefetch" href="/assets/js/280.ec13f58e.js"><link rel="prefetch" href="/assets/js/281.4266e436.js"><link rel="prefetch" href="/assets/js/282.56735a7a.js"><link rel="prefetch" href="/assets/js/283.70d7ad21.js"><link rel="prefetch" href="/assets/js/284.3dccddfa.js"><link rel="prefetch" href="/assets/js/285.62b34a26.js"><link rel="prefetch" href="/assets/js/286.cd4c9adf.js"><link rel="prefetch" href="/assets/js/287.e110a68f.js"><link rel="prefetch" href="/assets/js/288.68978e3e.js"><link rel="prefetch" href="/assets/js/289.9f5dcd49.js"><link rel="prefetch" href="/assets/js/29.e2e496dd.js"><link rel="prefetch" href="/assets/js/290.b86da697.js"><link rel="prefetch" href="/assets/js/291.a564a706.js"><link rel="prefetch" href="/assets/js/292.20a8d093.js"><link rel="prefetch" href="/assets/js/293.8f13aa53.js"><link rel="prefetch" href="/assets/js/294.c08ff719.js"><link rel="prefetch" href="/assets/js/295.68af44f0.js"><link rel="prefetch" href="/assets/js/296.62ac2911.js"><link rel="prefetch" href="/assets/js/297.ca51a0df.js"><link rel="prefetch" href="/assets/js/298.fe843a9c.js"><link rel="prefetch" href="/assets/js/299.93f52b75.js"><link rel="prefetch" href="/assets/js/3.256457cb.js"><link rel="prefetch" href="/assets/js/30.55c1d01b.js"><link rel="prefetch" href="/assets/js/300.316522e5.js"><link rel="prefetch" href="/assets/js/301.f99ac528.js"><link rel="prefetch" href="/assets/js/302.b37fa14b.js"><link rel="prefetch" href="/assets/js/303.b7af66cf.js"><link rel="prefetch" href="/assets/js/304.238e8c3b.js"><link rel="prefetch" href="/assets/js/305.3a59f2d0.js"><link rel="prefetch" href="/assets/js/306.03be0708.js"><link rel="prefetch" href="/assets/js/307.45284eb1.js"><link rel="prefetch" href="/assets/js/308.e96d9ca0.js"><link rel="prefetch" href="/assets/js/309.33e5c121.js"><link rel="prefetch" href="/assets/js/31.1f0c8edd.js"><link rel="prefetch" href="/assets/js/32.9e99cdeb.js"><link rel="prefetch" href="/assets/js/33.48c69098.js"><link rel="prefetch" href="/assets/js/34.a6843d71.js"><link rel="prefetch" href="/assets/js/35.7688e566.js"><link rel="prefetch" href="/assets/js/36.ac72cc70.js"><link rel="prefetch" href="/assets/js/37.1e25ed4a.js"><link rel="prefetch" href="/assets/js/38.a3765157.js"><link rel="prefetch" href="/assets/js/39.962392a9.js"><link rel="prefetch" href="/assets/js/4.8e736c7d.js"><link rel="prefetch" href="/assets/js/40.bc83f81b.js"><link rel="prefetch" href="/assets/js/41.1951766e.js"><link rel="prefetch" href="/assets/js/42.39113478.js"><link rel="prefetch" href="/assets/js/43.37c5c2be.js"><link rel="prefetch" href="/assets/js/44.d2b1f9dd.js"><link rel="prefetch" href="/assets/js/45.720c7121.js"><link rel="prefetch" href="/assets/js/46.30d1fc2a.js"><link rel="prefetch" href="/assets/js/47.3e6a5e18.js"><link rel="prefetch" href="/assets/js/48.2cb1bcdf.js"><link rel="prefetch" href="/assets/js/49.dc40f4fe.js"><link rel="prefetch" href="/assets/js/5.bedf66e3.js"><link rel="prefetch" href="/assets/js/50.004e7368.js"><link rel="prefetch" href="/assets/js/51.96480463.js"><link rel="prefetch" href="/assets/js/52.8171064f.js"><link rel="prefetch" href="/assets/js/53.aeabf1b7.js"><link rel="prefetch" href="/assets/js/54.a69a5494.js"><link rel="prefetch" href="/assets/js/55.4e3362b8.js"><link rel="prefetch" href="/assets/js/56.cf00203d.js"><link rel="prefetch" href="/assets/js/57.7dad9f05.js"><link rel="prefetch" href="/assets/js/58.5a599aa3.js"><link rel="prefetch" href="/assets/js/59.7a41d4ec.js"><link rel="prefetch" href="/assets/js/6.aa30f1b7.js"><link rel="prefetch" href="/assets/js/60.743bc681.js"><link rel="prefetch" href="/assets/js/61.30370304.js"><link rel="prefetch" href="/assets/js/62.1880bf44.js"><link rel="prefetch" href="/assets/js/63.625ede55.js"><link rel="prefetch" href="/assets/js/64.a0e699b3.js"><link rel="prefetch" href="/assets/js/65.1332e799.js"><link rel="prefetch" href="/assets/js/66.bf13ff4e.js"><link rel="prefetch" href="/assets/js/67.b1f02878.js"><link rel="prefetch" href="/assets/js/68.d9e97dc1.js"><link rel="prefetch" href="/assets/js/69.5fc5d0ad.js"><link rel="prefetch" href="/assets/js/7.b3b653a5.js"><link rel="prefetch" href="/assets/js/70.f0695449.js"><link rel="prefetch" href="/assets/js/71.f3df3763.js"><link rel="prefetch" href="/assets/js/72.ab0393fe.js"><link rel="prefetch" href="/assets/js/73.dc1ad4a0.js"><link rel="prefetch" href="/assets/js/74.98ea0207.js"><link rel="prefetch" href="/assets/js/75.75a79389.js"><link rel="prefetch" href="/assets/js/76.7b07f2b0.js"><link rel="prefetch" href="/assets/js/77.517e9335.js"><link rel="prefetch" href="/assets/js/78.90d5b20d.js"><link rel="prefetch" href="/assets/js/79.a2fdc1e8.js"><link rel="prefetch" href="/assets/js/8.e41b72a1.js"><link rel="prefetch" href="/assets/js/80.ce3db513.js"><link rel="prefetch" href="/assets/js/81.e9f26768.js"><link rel="prefetch" href="/assets/js/82.6ae00170.js"><link rel="prefetch" href="/assets/js/83.0a300de3.js"><link rel="prefetch" href="/assets/js/84.7f61b37c.js"><link rel="prefetch" href="/assets/js/85.52c4f70c.js"><link rel="prefetch" href="/assets/js/86.bb2b54e2.js"><link rel="prefetch" href="/assets/js/87.9632dc47.js"><link rel="prefetch" href="/assets/js/88.5736b64f.js"><link rel="prefetch" href="/assets/js/89.113520f8.js"><link rel="prefetch" href="/assets/js/9.72f4cc05.js"><link rel="prefetch" href="/assets/js/90.809eed5c.js"><link rel="prefetch" href="/assets/js/91.db653d35.js"><link rel="prefetch" href="/assets/js/92.f1c7d0c5.js"><link rel="prefetch" href="/assets/js/93.fabbd55d.js"><link rel="prefetch" href="/assets/js/94.951a8287.js"><link rel="prefetch" href="/assets/js/95.6b89432f.js"><link rel="prefetch" href="/assets/js/96.ab0e2ef7.js"><link rel="prefetch" href="/assets/js/97.bb53d2e5.js"><link rel="prefetch" href="/assets/js/98.16ee1d21.js"><link rel="prefetch" href="/assets/js/99.9b4ae87d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6732922a.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="xiongmao's blog" class="logo"> <span class="site-name can-hide">xiongmao's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/Operation/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>linux运维</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/nginx/" class="nav-link">nginx</a></li><li class="dropdown-subitem"><a href="/note/docker/" class="nav-link">docker</a></li><li class="dropdown-subitem"><a href="/note/elk/" class="nav-link">elk</a></li><li class="dropdown-subitem"><a href="/note/jenkins/" class="nav-link">jenkins</a></li><li class="dropdown-subitem"><a href="/note/jumpserver/" class="nav-link">jumpserver</a></li><li class="dropdown-subitem"><a href="/note/K8S/" class="nav-link">K8S</a></li><li class="dropdown-subitem"><a href="/note/linux/" class="nav-link">linux系统</a></li><li class="dropdown-subitem"><a href="/note/mysql/" class="nav-link">mysql</a></li><li class="dropdown-subitem"><a href="/note/ceph/" class="nav-link">ceph</a></li><li class="dropdown-subitem"><a href="/note/Prometheus/" class="nav-link">Prometheus</a></li><li class="dropdown-subitem"><a href="/note/redis/" class="nav-link">redis</a></li><li class="dropdown-subitem"><a href="/note/tomcat/" class="nav-link">tomcat</a></li><li class="dropdown-subitem"><a href="/note/zabbix/" class="nav-link">zabbix</a></li><li class="dropdown-subitem"><a href="/note/zookeeper/" class="nav-link">zookeeper</a></li><li class="dropdown-subitem"><a href="/note/KVM/" class="nav-link">KVM</a></li><li class="dropdown-subitem"><a href="/note/ansible/" class="nav-link">ansible</a></li></ul></li><li class="dropdown-item"><h4>网络运维</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/网络知识/" class="nav-link">网络知识</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/Develop/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/python/" class="nav-link">python</a></li><li class="dropdown-item"><!----> <a href="/note/shell/" class="nav-link">shell</a></li><li class="dropdown-item"><!----> <a href="/note/go/" class="nav-link">go</a></li></ul></div></div><div class="nav-item"><a href="/more/" class="nav-link">踩坑</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">网站</a></li><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea61/" class="nav-link">葵花宝典</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="/friends/" class="nav-link">友情链接</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/lzq70112/lzq70112.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/20200615022410.png"> <div class="blogger-info"><h3>胸毛君</h3> <span>运维界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/Operation/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>linux运维</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/nginx/" class="nav-link">nginx</a></li><li class="dropdown-subitem"><a href="/note/docker/" class="nav-link">docker</a></li><li class="dropdown-subitem"><a href="/note/elk/" class="nav-link">elk</a></li><li class="dropdown-subitem"><a href="/note/jenkins/" class="nav-link">jenkins</a></li><li class="dropdown-subitem"><a href="/note/jumpserver/" class="nav-link">jumpserver</a></li><li class="dropdown-subitem"><a href="/note/K8S/" class="nav-link">K8S</a></li><li class="dropdown-subitem"><a href="/note/linux/" class="nav-link">linux系统</a></li><li class="dropdown-subitem"><a href="/note/mysql/" class="nav-link">mysql</a></li><li class="dropdown-subitem"><a href="/note/ceph/" class="nav-link">ceph</a></li><li class="dropdown-subitem"><a href="/note/Prometheus/" class="nav-link">Prometheus</a></li><li class="dropdown-subitem"><a href="/note/redis/" class="nav-link">redis</a></li><li class="dropdown-subitem"><a href="/note/tomcat/" class="nav-link">tomcat</a></li><li class="dropdown-subitem"><a href="/note/zabbix/" class="nav-link">zabbix</a></li><li class="dropdown-subitem"><a href="/note/zookeeper/" class="nav-link">zookeeper</a></li><li class="dropdown-subitem"><a href="/note/KVM/" class="nav-link">KVM</a></li><li class="dropdown-subitem"><a href="/note/ansible/" class="nav-link">ansible</a></li></ul></li><li class="dropdown-item"><h4>网络运维</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/网络知识/" class="nav-link">网络知识</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发" class="dropdown-title"><a href="/Develop/" class="link-title">开发</a> <span class="title" style="display:none;">开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/python/" class="nav-link">python</a></li><li class="dropdown-item"><!----> <a href="/note/shell/" class="nav-link">shell</a></li><li class="dropdown-item"><!----> <a href="/note/go/" class="nav-link">go</a></li></ul></div></div><div class="nav-item"><a href="/more/" class="nav-link">踩坑</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">网站</a></li><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea61/" class="nav-link">葵花宝典</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="/friends/" class="nav-link">友情链接</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/lzq70112/lzq70112.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/b5e11111/" class="sidebar-link">Prometheus的原理及安装</a></li><li><a href="/pages/b5e11113/" class="sidebar-link">Prometheus监控集群应用</a></li><li><a href="/pages/1234/" class="sidebar-link">Prometheus集群监控</a></li><li><a href="/pages/b5e11114/" class="sidebar-link">Prometheus监控常用资源对象</a></li><li><a href="/pages/b5e111199/" class="sidebar-link">Grafana安装与使用</a></li><li><a href="/pages/b5e11115/" class="sidebar-link">PromQL的语法及使用</a></li><li><a href="/pages/b5e11116/" class="sidebar-link">Prometheus之Alertmanager的安装使用</a></li><li><a href="/pages/b5e11117/" aria-current="page" class="active sidebar-link">Prometheus之Operator安装及使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_1、什么是prometheus" class="sidebar-link">1、什么是Prometheus</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_2、介绍-operator的组件" class="sidebar-link">2、介绍 Operator的组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_2-1、prometheus" class="sidebar-link">2.1、Prometheus</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_2-2、alertmanager" class="sidebar-link">2.2、Alertmanager</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_2-3、thanosruler" class="sidebar-link">2.3、ThanosRuler</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_2-4、servicemonitor" class="sidebar-link">2.4、ServiceMonitor</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_2-5、podmonitor" class="sidebar-link">2.5、PodMonitor</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_2-6、probe" class="sidebar-link">2.6、Probe</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_2-7、prometheusrule" class="sidebar-link">2.7、PrometheusRule</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_2-8、alertmanagerconfig" class="sidebar-link">2.8、AlertmanagerConfig</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_3、安装" class="sidebar-link">3、安装</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_4、配置" class="sidebar-link">4、配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_4-1、监控kube-scheduler组件" class="sidebar-link">4.1、监控kube-scheduler组件</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_4-2、-kube-controller-manager-组件" class="sidebar-link">4.2、 kube-controller-manager 组件</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_4-3、数据查看与删除" class="sidebar-link">4.3、数据查看与删除</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_4-4、自定义监控etcd" class="sidebar-link">4.4、自定义监控etcd</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_4-5、配置-prometheusrule" class="sidebar-link">4.5、配置 PrometheusRule</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_4-6、配置告警" class="sidebar-link">4.6、配置告警</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_5、prometheus-operator自动发现" class="sidebar-link">5、Prometheus Operator自动发现</a></li><li class="sidebar-sub-header"><a href="/pages/b5e11117/#_6、数据持久化" class="sidebar-link">6、数据持久化</a></li></ul></li><li><a href="/pages/Prometheus1000/" class="sidebar-link">Prometheus之rules大全</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-0c557b5e><div class="articleInfo" data-v-0c557b5e><ul class="breadcrumbs" data-v-0c557b5e><li data-v-0c557b5e><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-0c557b5e></a></li> <li data-v-0c557b5e><a href="/categories/?category=%E3%80%8APrometheus%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0" title="分类" data-v-0c557b5e>《Prometheus》学习笔记</a></li></ul> <div class="info" data-v-0c557b5e><div title="作者" class="author iconfont icon-touxiang" data-v-0c557b5e><a href="https://github.com/lzq7012" target="_blank" title="作者" class="beLink" data-v-0c557b5e>xiongmao</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-0c557b5e><a href="javascript:;" data-v-0c557b5e>2021-09-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Prometheus之Operator安装及使用<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p>Prometheus之Operator安装及使用</p> <h2 id="_1、什么是prometheus"><a href="#_1、什么是prometheus" class="header-anchor">#</a> 1、什么是Prometheus</h2> <p>前面的章节中我们学习了用自定义的方式来对 Kubernetes 集群进行监控，基本上也能够完成监控报警的需求了。但实际上对上 Kubernetes 来说，还有更简单方式来监控报警，那就是 <a href="https://prometheus-operator.dev/" target="_blank" rel="noopener noreferrer">Prometheus Operator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。Prometheus Operator 为监控 Kubernetes 资源和 Prometheus 实例的管理提供了简单的定义，简化在 Kubernetes 上部署、管理和运行 Prometheus 和 Alertmanager 集群。</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/20210402143008.png" alt="img"></p> <h2 id="_2、介绍-operator的组件"><a href="#_2、介绍-operator的组件" class="header-anchor">#</a> 2、介绍 Operator的组件</h2> <p>Prometheus Operator 为 Kubernetes 提供了对 Prometheus 机器相关监控组件的本地部署和管理方案，该项目的目的是为了简化和自动化基于 Prometheus 的监控栈配置，主要包括以下几个功能：</p> <ul><li>Kubernetes 自定义资源：使用 Kubernetes CRD 来部署和管理 Prometheus、Alertmanager 和相关组件。</li> <li>简化的部署配置：直接通过 Kubernetes 资源清单配置 Prometheus，比如版本、持久化、副本、保留策略等等配置。</li> <li>Prometheus 监控目标配置：基于熟知的 Kubernetes 标签查询自动生成监控目标配置，无需学习 Prometheus 特地的配置。</li></ul> <p>首先我们先来了解下 Prometheus Operator 的架构图：</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/20200410141511.png" alt="promtheus opeator"></p> <p>上图是 Prometheus-Operator 官方提供的架构图，各组件以不同的方式运行在 Kubernetes 集群中，其中 Operator 是最核心的部分，作为一个控制器，他会去创建 Prometheus、ServiceMonitor、AlertManager 以及 PrometheusRule 等 CRD 资源对象，然后会一直 Watch 并维持这些资源对象的状态。</p> <p>在最新版本的 Operator 中提供了一下几个 CRD 资源对象：</p> <ul><li><code>Prometheus</code></li> <li><code>Alertmanager</code></li> <li><code>ServiceMonitor</code></li> <li><code>PodMonitor</code></li> <li><code>Probe</code></li> <li><code>ThanosRuler</code></li> <li><code>PrometheusRule</code></li> <li><code>AlertmanagerConfig</code></li></ul> <h3 id="_2-1、prometheus"><a href="#_2-1、prometheus" class="header-anchor">#</a> 2.1、Prometheus</h3> <p>该 CRD 声明定义了 Prometheus 期望在 Kubernetes 集群中运行的配置，提供了配置选项来配置副本、持久化、报警实例等。</p> <p>对于每个 Prometheus CRD 资源，Operator 都会以 StatefulSet 形式在相同的命名空间下部署对应配置的资源，Prometheus Pod 的配置是通过一个包含 Prometheus 配置的名为 <code>&lt;prometheus-name&gt;</code> 的 Secret 对象声明挂载的。</p> <p>该 CRD 根据标签选择来指定部署的 Prometheus 实例应该覆盖哪些 <code>ServiceMonitors</code>，然后 Operator 会根据包含的 ServiceMonitors 生成配置，并在包含配置的 Secret 中进行更新。</p> <p>如果未提供对 <code>ServiceMonitor</code> 的选择，则 Operator 会将 Secret 的管理留给用户，这样就可以提供自定义配置，同时还能享受 Operator 管理 Operator 的设置能力。</p> <h3 id="_2-2、alertmanager"><a href="#_2-2、alertmanager" class="header-anchor">#</a> 2.2、Alertmanager</h3> <p>该 CRD 定义了在 Kubernetes 集群中运行的 Alertmanager 的配置，同样提供了多种配置，包括持久化存储。</p> <p>对于每个 Alertmanager 资源，Operator 都会在相同的命名空间中部署一个对应配置的 StatefulSet，Alertmanager Pods 被配置为包含一个名为 <code>&lt;alertmanager-name&gt;</code> 的 Secret，该 Secret 以 <code>alertmanager.yaml</code> 为 key 的方式保存使用的配置文件。</p> <p>当有两个或更多配置的副本时，Operator 会在<strong>高可用</strong>模式下运行 Alertmanager 实例。</p> <h3 id="_2-3、thanosruler"><a href="#_2-3、thanosruler" class="header-anchor">#</a> 2.3、ThanosRuler</h3> <p>该 CRD 定义了一个 <code>Thanos Ruler</code> 组件的配置，以方便在 Kubernetes 集群中运行。通过 Thanos Ruler，可以跨多个Prometheus 实例处理记录和警报规则。</p> <p>一个 ThanosRuler 实例至少需要一个 <code>queryEndpoint</code>，它指向 <code>Thanos Queriers</code> 或 Prometheus 实例的位置。<code>queryEndpoints</code> 用于配置 Thanos 运行时的 <code>--query</code> 参数，更多信息也可以在 <a href="https://prometheus-operator.dev/docs/operator/design/thanos.md" target="_blank" rel="noopener noreferrer">Thanos 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中找到。</p> <h3 id="_2-4、servicemonitor"><a href="#_2-4、servicemonitor" class="header-anchor">#</a> 2.4、ServiceMonitor</h3> <p>该 CRD 定义了如何监控一组动态的服务，使用标签选择来定义哪些 Service 被选择进行监控。这可以让团队制定一个如何暴露监控指标的规范，然后按照这些规范自动发现新的服务，而无需重新配置。</p> <p>为了让 Prometheus 监控 Kubernetes 内的任何应用，需要存在一个 Endpoints 对象，Endpoints 对象本质上是IP地址的列表，通常 Endpoints 对象是由 Service 对象来自动填充的，Service 对象通过标签选择器匹配 Pod，并将其添加到Endpoints 对象中。一个 Service 可以暴露一个或多个端口，这些端口由多个 Endpoints 列表支持，这些端点一般情况下都是指向一个 Pod。</p> <p>Prometheus Operator 引入的这个 ServiceMonitor 对象就会发现这些 Endpoints 对象，并配置 Prometheus 监控这些 Pod。<code>ServiceMonitorSpec</code> 的 endpoints 部分就是用于配置这些 Endpoints 的哪些端口将被 scrape 指标的。</p> <blockquote><p>注意：endpoints（小写）是 ServiceMonitor CRD 中的字段，而 Endpoints（大写）是 Kubernetes 的一种对象。</p></blockquote> <p>ServiceMonitors 以及被发现的目标都可以来自任何命名空间，这对于允许跨命名空间监控的场景非常重要。使用 <code>PrometheusSpec</code> 的 <code>ServiceMonitorNamespaceSelector</code>，可以限制各自的 Prometheus 服务器选择的 ServiceMonitors 的命名空间。使用 <code>ServiceMonitorSpec</code> 的 <code>namespaceSelector</code>，可以限制 Endpoints 对象被允许从哪些命名空间中发现，要在所有命名空间中发现目标，<code>namespaceSelector</code> 必须为空：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>spec:
  namespaceSelector:
    any: true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_2-5、podmonitor"><a href="#_2-5、podmonitor" class="header-anchor">#</a> 2.5、PodMonitor</h3> <p>该 CRD 用于定义如何监控一组动态 pods，使用标签选择来定义哪些 pods 被选择进行监控。同样团队中可以制定一些规范来暴露监控的指标。</p> <p>Pod 是一个或多个容器的集合，可以在一些端口上暴露 Prometheus 指标。</p> <p>由 Prometheus Operator 引入的 PodMonitor 对象会发现这些 Pod，并为 Prometheus 服务器生成相关配置，以便监控它们。</p> <p><code>PodMonitorSpec</code> 中的 <code>PodMetricsEndpoints</code> 部分，用于配置 Pod 的哪些端口将被 scrape 指标，以及使用哪些参数。</p> <p>PodMonitors 和发现的目标可以来自任何命名空间，这同样对于允许跨命名空间的监控用例是很重要的。使用 <code>PodMonitorSpec</code> 的 <code>namespaceSelector</code>，可以限制 Pod 被允许发现的命名空间，要在所有命名空间中发现目标，<code>namespaceSelector</code> 必须为空：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>spec:
  namespaceSelector:
    any: true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p><code>PodMonitor</code> 和 <code>ServieMonitor</code> 最大的区别就是不需要有对应的 Service。</p></blockquote> <h3 id="_2-6、probe"><a href="#_2-6、probe" class="header-anchor">#</a> 2.6、Probe</h3> <p>该 CRD 用于定义如何监控一组 Ingress 和静态目标。除了 target 之外，<code>Probe</code> 对象还需要一个 <code>prober</code>，它是监控的目标并为 Prometheus 提供指标的服务。例如可以通过使用 <a href="https://github.com/prometheus/blackbox_exporter/" target="_blank" rel="noopener noreferrer">blackbox-exporter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来提供这个服务。</p> <h3 id="_2-7、prometheusrule"><a href="#_2-7、prometheusrule" class="header-anchor">#</a> 2.7、PrometheusRule</h3> <p>用于配置 Prometheus 的 Rule 规则文件，包括 recording rules 和 alerting，可以自动被 Prometheus 加载。</p> <h3 id="_2-8、alertmanagerconfig"><a href="#_2-8、alertmanagerconfig" class="header-anchor">#</a> 2.8、AlertmanagerConfig</h3> <p>在以前的版本中要配置 Alertmanager 都是通过 Configmap 来完成的，在 v0.43 版本后新增该 CRD，可以将 Alertmanager 的配置分割成不同的子对象进行配置，允许将报警路由到自定义 Receiver 上，并配置抑制规则。</p> <p><code>AlertmanagerConfig</code> 可以在命名空间级别上定义，为 Alertmanager 提供一个聚合的配置。这里提供了一个如何使用它的<a href="https://prometheus-operator.dev/docs/operator/example/user-guides/alerting/alertmanager-config-example.yaml" target="_blank" rel="noopener noreferrer">例子<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。不过需要注意这个 CRD 还不稳定。</p> <p>这样我们要在集群中监控什么数据，就变成了直接去操作 Kubernetes 集群的资源对象了，是这样比之前手动的方式就方便很多了。</p> <h2 id="_3、安装"><a href="#_3、安装" class="header-anchor">#</a> 3、安装</h2> <p>为了使用 Prometheus-Operator，这里直接使用 <a href="https://github.com/prometheus-operator/kube-prometheus.git" target="_blank" rel="noopener noreferrer">kube-prometheus<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这个项目来进行安装，该项目和 Prometheus-Operator 的区别就类似于 Linux 内核和 CentOS/Ubuntu 这些发行版的关系，真正起作用的是 Operator 去实现的，而 kube-prometheus 只是利用 Operator 编写了一系列常用的监控资源清单。</p> <p>首先 clone 项目代码，切换到当前最新的 <code>v0.7.0</code> 版本：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/prometheus-operator/kube-prometheus.git
<span class="token builtin class-name">cd</span> kube-prometheus <span class="token operator">&amp;&amp;</span> <span class="token function">git</span> checkout v0.7.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>进入到 <code>manifests</code> 目录下面，首先我们需要安装 <code>setup</code> 目录下面的 CRD 和 Operator 资源对象，等待它们可用后再创建其余资源：</p> <div class="language-BASH line-numbers-mode"><pre class="language-bash"><code> kubectl apply -f setup/
 kubectl get pods -n monitoring
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>NAME                                   READY   STATUS    RESTARTS   AGE
prometheus-operator-7649c7454f-bdlzn   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          5m1s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这会创建一个名为 <code>monitoring</code> 的命名空间，以及相关的 CRD 资源对象声明和 Prometheus Operator 控制器。前面章节中我们讲解过 CRD 和 Operator 的使用，当我们声明完 CRD 过后，就可以来自定义资源清单了，但是要让我们声明的自定义资源对象生效就需要安装对应的 Operator 控制器，这里我们都已经安装了，所以接下来就可以来用 CRD 创建真正的自定义资源对象了。在 <code>manifests</code> 目录下面的就是我们要去创建的 Prometheus、Alertmanager 以及各种监控对象的资源清单，直接安装即可：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code> kubectl apply -f manifests/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这会自动安装 node-exporter、kube-state-metrics、grafana、prometheus-adapter 以及 prometheus 和 alertmanager 等大量组件，而且 prometheus 和 alertmanager 还是多副本的。</p> <p><code>kubectl get pods -n monitoring</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>NAME                                   READY   STATUS    RESTARTS   AGE
alertmanager-main-0                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          18m
alertmanager-main-1                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          18m
alertmanager-main-2                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          18m
grafana-f8cd57fcf-vzrll                <span class="token number">1</span>/1     Running   <span class="token number">0</span>          18m
kube-state-metrics-587bfd4f97-99rbg    <span class="token number">3</span>/3     Running   <span class="token number">0</span>          18m
node-exporter-7qmfh                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          18m
node-exporter-bkcjf                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          18m
node-exporter-fx7m2                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          18m
node-exporter-hsz5h                    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          18m
prometheus-adapter-69b8496df6-6lg95    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          18m
prometheus-k8s-0                       <span class="token number">2</span>/2     Running   <span class="token number">1</span>          18m
prometheus-k8s-1                       <span class="token number">2</span>/2     Running   <span class="token number">1</span>          18m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>kubectl get svc -n monitoring</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                      AGE
alertmanager-main       ClusterIP   <span class="token number">10.68</span>.196.76    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9093</span>/TCP                     28m
alertmanager-operated   ClusterIP   None            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9093</span>/TCP,9094/TCP,9094/UDP   28m
grafana                 ClusterIP   <span class="token number">10.68</span>.155.167   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3000</span>/TCP                     28m
kube-state-metrics      ClusterIP   None            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8443</span>/TCP,9443/TCP            28m
node-exporter           ClusterIP   None            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9100</span>/TCP                     28m
prometheus-adapter      ClusterIP   <span class="token number">10.68</span>.239.95    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP                      28m
prometheus-k8s          ClusterIP   <span class="token number">10.68</span>.161.36    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>/TCP                     28m
prometheus-operated     ClusterIP   None            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>/TCP                     28m
prometheus-operator     ClusterIP   None            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8443</span>/TCP                     32m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到上面针对 grafana、alertmanager 和 prometheus 都创建了一个类型为 ClusterIP 的 Service，当然如果我们想要在外网访问这两个服务的话可以通过创建对应的 Ingress 对象或者使用 NodePort 类型的 Service，我们这里为了简单，直接使用 NodePort 类型的服务即可，编辑 <code>grafana</code>、<code>alertmanager-main</code> 和 <code>prometheus-k8s</code> 这3个 Service，将服务类型更改为 NodePort:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 将 type: ClusterIP 更改为 type: NodePort</span>
kubectl edit svc grafana -n monitoring  
kubectl edit svc alertmanager-main -n monitoring
kubectl edit svc prometheus-k8s -n monitoring
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>更改完成后，就可以通过上面的 NodePort 去访问对应的服务了，比如查看 prometheus 的服务发现页面：</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20211005095539267.png" alt="image-20211005095539267"></p> <p>可以看到已经监控上了很多指标数据了，上面我们可以看到 Prometheus 是两个副本，我们这里通过 Service 去访问，按正常来说请求是会去轮询访问后端的两个 Prometheus 实例的，但实际上我们这里访问的时候始终是路由到后端的一个实例上去，因为这里的 Service 在创建的时候添加了 <code>sessionAffinity: ClientIP</code> 这样的属性，会根据 <code>ClientIP</code> 来做 session 亲和性，所以我们不用担心请求会到不同的副本上去：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> web
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> ClientIP
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>为什么会担心请求会到不同的副本上去呢？正常多副本应该是看成高可用的常用方案，理论上来说不同副本本地的数据是一致的，但是需要注意的是 Prometheus 的主动 Pull 拉取监控指标的方式，由于抓取时间不能完全一致，即使一致也不一定就能保证网络没什么问题，所以最终不同副本下存储的数据很大可能是不一样的，所以这里我们配置了 session 亲和性，可以保证我们在访问数据的时候始终是一致的。</p></blockquote> <h2 id="_4、配置"><a href="#_4、配置" class="header-anchor">#</a> 4、配置</h2> <p>我们可以看到上面的监控指标大部分的配置都是正常的，只有两三个没有管理到对应的监控目标，比如 <code>kube-controller-manager</code> 和 <code>kube-scheduler</code> 这两个系统组件。</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/20210402181028.png" alt="img"></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>kube-scheduler、 kube-controller-manager  默认绑定了127.0.0.1 端口 ，组件没有开放监听端口</p></div> <h3 id="_4-1、监控kube-scheduler组件"><a href="#_4-1、监控kube-scheduler组件" class="header-anchor">#</a> 4.1、监控kube-scheduler组件</h3> <p><strong>POD部署方式</strong></p> <p>这其实就和 <code>ServiceMonitor</code> 的定义有关系了，查看下 kube-scheduler 组件对应的 ServiceMonitor 资源的定义，<code>manifests/prometheus-serviceMonitorKubeScheduler.yaml</code>：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">bearerTokenFile</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/token  <span class="token comment"># token 文件</span>
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s  <span class="token comment"># 每30s获取一次信息</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>metrics  <span class="token comment"># 对应 service 的端口名</span>
    <span class="token key atrule">scheme</span><span class="token punctuation">:</span> https  <span class="token comment"># 注意是使用 https 协议</span>
    <span class="token key atrule">tlsConfig</span><span class="token punctuation">:</span>  <span class="token comment"># 跳过安全校验</span>
      <span class="token key atrule">insecureSkipVerify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>app  <span class="token comment"># 用于从中检索任务名称的标签</span>
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>  <span class="token comment"># 表示去匹配某一命名空间中的 Service，如果想从所有的namespace中匹配用any:true</span>
    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>  <span class="token comment"># 匹配的 Service 的 labels，如果使用 mathLabels，则下面的所有标签都匹配时才会匹配该 service，如果使用 matchExpressions，则至少匹配一个标签的 service 都会被选择</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>通过 <code>selector.matchLabels</code> 在 <code>kube-system</code> 这个命名空间下面匹配具有 <code>k8s-app=kube-scheduler</code> 这样的 Service，但是系统中根本就没有对应的 Service</p> <p>所以我们需要去创建一个对应的 Service 对象，才能与 <code>ServiceMonitor</code> 进行关联</p> <p><code>vim prometheus-kubeSchedulerService.yaml</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>  <span class="token comment"># 必须和上面的 ServiceMonitor 下面的 matchLabels 保持一致</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10259</span>  
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10259</span>
    <span class="token comment"># 需要注意现在版本默认的安全端口是10259</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>其中最重要的是上面 labels 和 selector 部分，labels 区域的配置必须和我们上面的 ServiceMonitor 对象中的 selector 保持一致，selector 下面配置的是 <code>component=kube-scheduler</code>，为什么会是这个 label 标签呢，我们可以去 describe 下 kube-scheduler 这个 Pod：</p> <p><code>kubectl describe pod kube-scheduler-master1 -n kube-system</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Name:                 kube-scheduler-master1
Namespace:            kube-system
Priority:             <span class="token number">2000001000</span>
Priority Class Name:  system-node-critical
Node:                 master1/192.168.31.75
Start Time:           Mon, <span class="token number">29</span> Mar <span class="token number">2021</span> <span class="token number">18</span>:15:46 +0800
Labels:               <span class="token assign-left variable">component</span><span class="token operator">=</span>kube-scheduler
                      <span class="token assign-left variable">tier</span><span class="token operator">=</span>control-plane
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>我们可以看到这个 Pod 具有 <code>component=kube-scheduler</code> 和 <code>tier=control-plane</code> 这两个标签，而前面这个标签具有更唯一的特性，所以使用前面这个标签较好，这样上面创建的 Service 就可以和我们的 Pod 进行关联了，直接创建即可：</p> <p><code>kubectl apply -f prometheus-kubeSchedulerService.yaml</code></p> <p><code>kubectl get svc -n kube-system -l k8s-app=kube-scheduler</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>     AGE
kube-scheduler   ClusterIP   <span class="token number">10.100</span>.66.246   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">10251</span>/TCP   2m2s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>创建完成后，隔一小会儿后去 Prometheus 页面上查看 targets 下面 kube-scheduler 已经有采集的目标了，但是报了 <code>connect: connection refused</code> 这样的错误：</p> <p><img src="https://bxdc-static.oss-cn-beijing.aliyuncs.com/images/20210402182143.png" alt="img"></p> <p>这是因为 kube-scheduler 启动的时候默认绑定的是 <code>127.0.0.1</code> 地址，所以要通过 IP 地址去访问就被拒绝了，我们可以查看 master 节点上的静态 Pod 资源清单来确认这一点：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># /etc/kubernetes/manifests/kube-scheduler.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>  <span class="token comment"># 必须和上面的 ServiceMonitor 下面的 matchLabels 保持一致</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>scheduler
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>authentication<span class="token punctuation">-</span>kubeconfig=/etc/kubernetes/scheduler.conf
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>authorization<span class="token punctuation">-</span>kubeconfig=/etc/kubernetes/scheduler.conf
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>bind<span class="token punctuation">-</span>address=127.0.0.1  <span class="token comment"># 绑定了127.0.0.1</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubeconfig=/etc/kubernetes/scheduler.conf
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>leader<span class="token punctuation">-</span>elect=true
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>port=0  <span class="token comment"># 如果为0，则不提供 HTTP 服务，--secure-port 默认值：10259，通过身份验证和授权为 HTTPS 服务的端口，如果为 0，则不提供 HTTPS。</span>
<span class="token punctuation">...</span><span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>我们可以直接将上面的 <code>--bind-address=127.0.0.1</code> 更改为 <code>--bind-address=0.0.0.0</code> 即可，更改后 kube-scheduler 会自动重启，重启完成后再去查看 Prometheus 上面的采集目标就正常了。</p> <p><strong>二进制部署K8S组件的方式的监控</strong></p> <p>监控需要指定ep和service</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10259</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10259</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>kube-scheduler-endpoint.yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.2.22
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.2.23
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10259</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">vim</span> /etc/systemd/system/kube-scheduler.service <span class="token comment"># 修改adress绑定为0.0.0.0</span>
systemctl daemon-reload
systemctl restart kube-scheduler
systemctl restart kube-controller-manager
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_4-2、-kube-controller-manager-组件"><a href="#_4-2、-kube-controller-manager-组件" class="header-anchor">#</a> 4.2、 kube-controller-manager 组件</h3> <p>可以用同样的方式来修复下 kube-controller-manager 组件的监控，创建一个如下所示的 Service 对象，只是端口改成 10257：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># prometheus-kubeControllerManagerService.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10257</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10257</span>  <span class="token comment"># controller-manager 的安全端口为10257</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>二进制部署K8S组件的方式的监控</strong></p> <p>kube-controller-manager-service.yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10257</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10257</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>kube-controller-manager-endpoint.yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.2.22
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.2.23
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10257</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>然后将 kube-controller-manager 静态 Pod 的资源清单文件中的参数 <code>--bind-address=127.0.0.1</code> 更改为 <code>--bind-address=0.0.0.0</code>。</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/20210402185132.png" alt="kube-scheduler-controller-manager"></p> <blockquote><p><strong>如果二进制部署的组件https无法监控的情况，改为http即可</strong></p></blockquote> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">curl</span> -s --cacert /etc/kubeasz/clusters/_cluster_name_/ssl/ca.pem --cert /etc/kubeasz/clusters/_cluster_name_/ssl/admin.pem --key /etc/kubeasz/clusters/_cluster_name_/ssl/admin-key.pem https://127.0.0.1:10259/metrics <span class="token operator">|</span><span class="token function">head</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># prometheus-serviceMonitorKubeScheduler.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">bearerTokenFile</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/token
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s
    <span class="token key atrule">port</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
    <span class="token comment"># 改为http</span>
    <span class="token key atrule">scheme</span><span class="token punctuation">:</span> http
    <span class="token comment"># 改为http</span>
    <span class="token key atrule">tlsConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">insecureSkipVerify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>app
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># kube-controller-manager-svc.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10252</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10252</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.2.22
  <span class="token comment"># 集群节点地址</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.2.23
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10252</span>
    <span class="token comment"># 非https的端口</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_4-3、数据查看与删除"><a href="#_4-3、数据查看与删除" class="header-anchor">#</a> 4.3、数据查看与删除</h3> <p>上面的监控数据配置完成后，我们就可以去查看下 Grafana 下面的监控图表了，同样使用上面的 NodePort 访问即可，第一次登录使用 <code>admin:admin</code> 登录即可，进入首页后，我们可以发现其实 Grafana 已经有很多配置好的监控图表了。</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20211006135148530.png" alt="image-20211006135148530"></p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/20210402185349.png" alt="grafana dashboard"></p> <p>我们可以随便选择一个 Dashboard 查看监控图表信息。</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/20210402185609.png" alt="grafana dashboard"></p> <p>接下来我们再来学习如何完全自定义一个 <code>ServiceMonitor</code> 以及其他的相关配置。</p> <p>如果要清理 Prometheus-Operator，可以直接删除对应的资源清单即可：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> kubectl delete -f manifests/ 
 kubectl delete -f manifests/setup/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_4-4、自定义监控etcd"><a href="#_4-4、自定义监控etcd" class="header-anchor">#</a> 4.4、自定义监控etcd</h3> <p>我的环境是二进制部署的，查看配置</p> <p><code>vim /etc/systemd/system/etcd.service</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>notify
<span class="token assign-left variable">WorkingDirectory</span><span class="token operator">=</span>/var/lib/etcd/
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/opt/kube/bin/etcd <span class="token punctuation">\</span>
  --name<span class="token operator">=</span>etcd-192.168.2.22 <span class="token punctuation">\</span>
  --cert-file<span class="token operator">=</span>/etc/kubernetes/ssl/etcd.pem <span class="token punctuation">\</span>
  --key-file<span class="token operator">=</span>/etc/kubernetes/ssl/etcd-key.pem <span class="token punctuation">\</span>
  --peer-cert-file<span class="token operator">=</span>/etc/kubernetes/ssl/etcd.pem <span class="token punctuation">\</span>
  --peer-key-file<span class="token operator">=</span>/etc/kubernetes/ssl/etcd-key.pem <span class="token punctuation">\</span>
  --trusted-ca-file<span class="token operator">=</span>/etc/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
  --peer-trusted-ca-file<span class="token operator">=</span>/etc/kubernetes/ssl/ca.pem <span class="token punctuation">\</span>
  --initial-advertise-peer-urls<span class="token operator">=</span>https://192.168.2.22:2380 <span class="token punctuation">\</span>
  --listen-peer-urls<span class="token operator">=</span>https://192.168.2.22:2380 <span class="token punctuation">\</span>
  --listen-metrics-urls<span class="token operator">=</span>http://0.0.0.0:2381 <span class="token punctuation">\</span>
  <span class="token comment"># 指定http metrics监听</span>
  --listen-client-urls<span class="token operator">=</span>https://192.168.2.22:2379,http://127.0.0.1:2379 <span class="token punctuation">\</span>
  --advertise-client-urls<span class="token operator">=</span>https://192.168.2.22:2379 <span class="token punctuation">\</span>
  --initial-cluster-token<span class="token operator">=</span>etcd-cluster-0 <span class="token punctuation">\</span>
  --initial-cluster<span class="token operator">=</span>etcd-192.168.2.22<span class="token operator">=</span>https://192.168.2.22:2380,etcd-192.168.2.23<span class="token operator">=</span>https://192.168.2.23:2380,etcd-192.168.2.25<span class="token operator">=</span>https://192.168.2.25:2380 <span class="token punctuation">\</span>
  --initial-cluster-state<span class="token operator">=</span>new <span class="token punctuation">\</span>
  --data-dir<span class="token operator">=</span>/var/lib/etcd <span class="token punctuation">\</span>
  --snapshot-count<span class="token operator">=</span><span class="token number">50000</span> <span class="token punctuation">\</span>
  --auto-compaction-retention<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>
  --max-request-bytes<span class="token operator">=</span><span class="token number">10485760</span> <span class="token punctuation">\</span>
  --auto-compaction-mode<span class="token operator">=</span>periodic <span class="token punctuation">\</span>
  --quota-backend-bytes<span class="token operator">=</span><span class="token number">8589934592</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">15</span>
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>
<span class="token assign-left variable">OOMScoreAdjust</span><span class="token operator">=</span>-999
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><code>--listen-metrics-urls=http://127.0.0.1:2381</code> 的配置，该参数就是来指定 metrics 接口运行在 2381 端口下面的，而且是 http 的协议，所以也不需要什么证书配置</p> <p><code>kubectl apply -f prometheus-serviceMonitorEtcd.yaml</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#  prometheus-serviceMonitorEtcd.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>k8s
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>app
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> port
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 15s
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>Service 的 clusterIP 设置为 None，新版本的 etcd 将 metrics 接口数据放置到了 2381 端口。直接创建该资源对象即可：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># etcd-service.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> etcd
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token comment"># 一定要设置 clusterIP:None</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> port
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2381</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> etcd
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.2.22
      <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.2.23
      <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.2.25
      <span class="token comment"># 指定etcd节点地址，如果是集群则继续向下添加</span>
        <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> etc<span class="token punctuation">-</span>master
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> port
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2381</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20211006195755621.png" alt="image-20211006195755621"></p> <h3 id="_4-5、配置-prometheusrule"><a href="#_4-5、配置-prometheusrule" class="header-anchor">#</a> 4.5、配置 PrometheusRule</h3> <p><strong>配置 之前要知道Prometheus 和 AlertManager 组件如何关联上的</strong></p> <p>在 Prometheus Dashboard 的 Config 页面下面查看关于 AlertManager 的配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 30s
  <span class="token key atrule">scrape_timeout</span><span class="token punctuation">:</span> 10s
  <span class="token key atrule">evaluation_interval</span><span class="token punctuation">:</span> 30s
  <span class="token key atrule">external_labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> monitoring/k8s
    <span class="token key atrule">prometheus_replica</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span><span class="token number">1</span>
<span class="token key atrule">alerting</span><span class="token punctuation">:</span>
  <span class="token key atrule">alert_relabel_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;
    <span class="token key atrule">regex</span><span class="token punctuation">:</span> prometheus_replica
    <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
    <span class="token key atrule">action</span><span class="token punctuation">:</span> labeldrop
  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">scheme</span><span class="token punctuation">:</span> http
    <span class="token key atrule">path_prefix</span><span class="token punctuation">:</span> /
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s
    <span class="token key atrule">api_version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_name<span class="token punctuation">]</span>
      <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;
      <span class="token comment"># 匹配svc名字</span>
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> alertmanager<span class="token punctuation">-</span>main     
      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
      <span class="token key atrule">action</span><span class="token punctuation">:</span> keep
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_endpoint_port_name<span class="token punctuation">]</span>
      <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> web
      <span class="token comment"># 匹配端口</span>
      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
      <span class="token key atrule">action</span><span class="token punctuation">:</span> keep
    <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>
    <span class="token comment"># 自动发现匹配为alertmanager </span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> endpoints
      <span class="token key atrule">namespaces</span><span class="token punctuation">:</span>
        <span class="token key atrule">names</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> monitoring
<span class="token key atrule">rule_files</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> /etc/prometheus/rules/prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>rulefiles<span class="token punctuation">-</span>0/<span class="token important">*.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>通过 role 为<code>endpoints</code> 的 kubernetes 的自动发现机制获取的，匹配的是服务名为 <code>alertmanager-main</code>，端口名为 web 的 Service 服务</p> <p><code>kubectl describe svc alertmanager-main -n monitoring</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>Name:              alertmanager-main
Namespace:         monitoring
Labels:            <span class="token assign-left variable">alertmanager</span><span class="token operator">=</span>main
Annotations:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Selector:          <span class="token assign-left variable">alertmanager</span><span class="token operator">=</span>main,app<span class="token operator">=</span>alertmanager
Type:              ClusterIP
IP Families:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
IP:                <span class="token number">10.68</span>.1.148
IPs:               <span class="token number">10.68</span>.1.148
Port:              web  <span class="token number">9093</span>/TCP
TargetPort:        web/TCP
Endpoints:         <span class="token number">172.20</span>.247.15:9093,172.20.247.16:9093,172.20.247.18:9093
Session Affinity:  ClientIP
Events:            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>alertmanager-main</code>，Port 定义的名称也是 <code>web</code>，符合上面的规则，所以 Prometheus 和 AlertManager 组件就正确关联上了。而对应的报警规则文件位于：<code>/etc/prometheus/rules/prometheus-k8s-rulefiles-0/</code>目录下面所有的 YAML 文件。我们可以进入 Prometheus 的 Pod 中验证下该目录下面是否有 YAML 文件：</p> <p><code>kubectl exec -it prometheus-k8s-0 /bin/sh -n monitoring</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.
Defaulting container name to prometheus.
Use <span class="token string">'kubectl describe pod/prometheus-k8s-0 -n monitoring'</span> to see all of the containers <span class="token keyword">in</span> this pod.
/prometheus $ <span class="token function">ls</span> /etc/prometheus/rules/prometheus-k8s-rulefiles-0/
<span class="token comment"># 规则文件放置在这个文件夹中</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>是由<code>prometheus-rules.yaml</code>  提供</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># prometheus-rules.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PrometheusRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
    <span class="token key atrule">role</span><span class="token punctuation">:</span> alert<span class="token punctuation">-</span>rules
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>rules
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>那prometheus是创建时就设置rule资源的匹配规则</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Prometheus
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
  <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">alerting</span><span class="token punctuation">:</span>
    <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager<span class="token punctuation">-</span>main
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
      <span class="token key atrule">port</span><span class="token punctuation">:</span> web
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/prometheus/prometheus<span class="token punctuation">:</span>v2.22.1
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
  <span class="token key atrule">podMonitorNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">podMonitorSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">probeNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">probeSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 400Mi
  <span class="token key atrule">ruleSelector</span><span class="token punctuation">:</span>
  <span class="token comment"># 规则选择匹配</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
    <span class="token comment"># 满足一下两个标签都的资源都会被发现</span>
      <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
      <span class="token key atrule">role</span><span class="token punctuation">:</span> alert<span class="token punctuation">-</span>rules
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">2000</span>
    <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
  <span class="token key atrule">serviceMonitorNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">serviceMonitorSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v2.22.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>正式创建etcd的报警</strong></p> <p>只需要创建一个具有 <code>prometheus=k8s</code> 和 <code>role=alert-rules</code> 标签的 <code>PrometheusRule</code> 对象就行</p> <p>如何要添加一个 etcd 是否可用的报警，我们知道 etcd 整个集群有一半以上的节点可用的话集群就是可用的，所以我们判断如果不可用的 etcd 数量超过了一半那么就触发报警，创建文件</p> <p><code>prometheus-etcdRules.yaml</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PrometheusRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
    <span class="token key atrule">role</span><span class="token punctuation">:</span> alert<span class="token punctuation">-</span>rules
    <span class="token comment"># label标签十分重要</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>rules
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">groups</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd
      <span class="token key atrule">rules</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> EtcdClusterUnavailable
          <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
            <span class="token key atrule">summary</span><span class="token punctuation">:</span> etcd cluster small
            <span class="token key atrule">description</span><span class="token punctuation">:</span> If one more etcd peer goes down the cluster will be unavailable
          <span class="token key atrule">expr</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            count(up{job=&quot;etcd&quot;} == 0) &gt; (count(up{job=&quot;etcd&quot;}) / 2 - 1)</span>
          <span class="token key atrule">for</span><span class="token punctuation">:</span> 3m
          <span class="token key atrule">labels</span><span class="token punctuation">:</span>
            <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
            <span class="token comment"># 告警标签设置</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>Prometheus的alerts 新规则</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20211007162609390.png" alt="image-20211007162609390"></p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20211007162748419.png" alt="image-20211007162748419"></p> <h3 id="_4-6、配置告警"><a href="#_4-6、配置告警" class="header-anchor">#</a> 4.6、配置告警</h3> <p>这些报警信息用怎样的方式去发送呢？前面的课程中我们知道我们可以通过 AlertManager 的配置文件去配置各种报警接收器，现在我们是通过 Operator 提供的 alertmanager 资源对象创建的组件，应该怎样去修改配置呢？</p> <p>首先我们去 Alertmanager 的页面上 <code>status</code> 路径下面查看 AlertManager 的配置信息:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token key atrule">resolve_timeout</span><span class="token punctuation">:</span> 5m
  <span class="token key atrule">http_config</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">smtp_hello</span><span class="token punctuation">:</span> localhost
  <span class="token key atrule">smtp_require_tls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">pagerduty_url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//events.pagerduty.com/v2/enqueue
  <span class="token key atrule">opsgenie_api_url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//api.opsgenie.com/
  <span class="token key atrule">wechat_api_url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//qyapi.weixin.qq.com/cgi<span class="token punctuation">-</span>bin/
  <span class="token key atrule">victorops_api_url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//alert.victorops.com/integrations/generic/20131114/alert/
<span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token key atrule">receiver</span><span class="token punctuation">:</span> Default
  <span class="token key atrule">group_by</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> namespace
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">receiver</span><span class="token punctuation">:</span> Watchdog
    <span class="token key atrule">match</span><span class="token punctuation">:</span>
      <span class="token key atrule">alertname</span><span class="token punctuation">:</span> Watchdog
  <span class="token punctuation">-</span> <span class="token key atrule">receiver</span><span class="token punctuation">:</span> Critical
    <span class="token key atrule">match</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
  <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 30s
  <span class="token key atrule">group_interval</span><span class="token punctuation">:</span> 5m
  <span class="token key atrule">repeat_interval</span><span class="token punctuation">:</span> 12h
<span class="token key atrule">inhibit_rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">source_match</span><span class="token punctuation">:</span>
    <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
  <span class="token key atrule">target_match_re</span><span class="token punctuation">:</span>
    <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning<span class="token punctuation">|</span>info
  <span class="token key atrule">equal</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> namespace
  <span class="token punctuation">-</span> alertname
<span class="token punctuation">-</span> <span class="token key atrule">source_match</span><span class="token punctuation">:</span>
    <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
  <span class="token key atrule">target_match_re</span><span class="token punctuation">:</span>
    <span class="token key atrule">severity</span><span class="token punctuation">:</span> info
  <span class="token key atrule">equal</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> namespace
  <span class="token punctuation">-</span> alertname
<span class="token key atrule">receivers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Default
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Watchdog
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Critical
<span class="token key atrule">templates</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>这些配置信息实际上是来自于 Prometheus-Operator 自动创建的名为 <code>alertmanager-main-generated</code> 的 Secret 对象：</p> <p><code>kubectl get secret alertmanager-main-generated -n monitoring -o json | jq -r '.data.&quot;alertmanager.yaml&quot;' | base64 --decode</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">&quot;global&quot;</span><span class="token punctuation">:</span>
  <span class="token key atrule">&quot;resolve_timeout&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;5m&quot;</span>
<span class="token key atrule">&quot;inhibit_rules&quot;</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">&quot;equal&quot;</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;namespace&quot;</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;alertname&quot;</span>
  <span class="token key atrule">&quot;source_match&quot;</span><span class="token punctuation">:</span>
    <span class="token key atrule">&quot;severity&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;critical&quot;</span>
  <span class="token key atrule">&quot;target_match_re&quot;</span><span class="token punctuation">:</span>
    <span class="token key atrule">&quot;severity&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;warning|info&quot;</span>
<span class="token punctuation">-</span> <span class="token key atrule">&quot;equal&quot;</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;namespace&quot;</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;alertname&quot;</span>
  <span class="token key atrule">&quot;source_match&quot;</span><span class="token punctuation">:</span>
    <span class="token key atrule">&quot;severity&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;warning&quot;</span>
  <span class="token key atrule">&quot;target_match_re&quot;</span><span class="token punctuation">:</span>
    <span class="token key atrule">&quot;severity&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;info&quot;</span>
<span class="token key atrule">&quot;receivers&quot;</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Default&quot;</span>
<span class="token punctuation">-</span> <span class="token key atrule">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Watchdog&quot;</span>
<span class="token punctuation">-</span> <span class="token key atrule">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Critical&quot;</span>
<span class="token key atrule">&quot;route&quot;</span><span class="token punctuation">:</span>
  <span class="token key atrule">&quot;group_by&quot;</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;namespace&quot;</span>
  <span class="token key atrule">&quot;group_interval&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;5m&quot;</span>
  <span class="token key atrule">&quot;group_wait&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;30s&quot;</span>
  <span class="token key atrule">&quot;receiver&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Default&quot;</span>
  <span class="token key atrule">&quot;repeat_interval&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;12h&quot;</span>
  <span class="token key atrule">&quot;routes&quot;</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">&quot;match&quot;</span><span class="token punctuation">:</span>
      <span class="token key atrule">&quot;alertname&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Watchdog&quot;</span>
    <span class="token key atrule">&quot;receiver&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Watchdog&quot;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">&quot;match&quot;</span><span class="token punctuation">:</span>
      <span class="token key atrule">&quot;severity&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;critical&quot;</span>
    <span class="token key atrule">&quot;receiver&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Critical&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>我们可以看到内容和上面查看的配置信息是一致的，所以如果我们想要添加自己的接收器，我们就可以直接更改这个文件，但是这里的内容是 base64 编码过后的，如果手动添加内容就非常不方便</p> <p><strong>正式部署</strong></p> <p>Prometheus-Operator 新增了一个 <code>AlertmanagerConfig</code> 的 CRD，比如我们将 <code>Critical</code> 这个接收器的报警信息都发送到钉钉进行报警。</p> <p><a href="/pages/b5e11116/">钉钉报警hook</a></p> <p>然后新建一个 <code>AlertmanagerConfig</code> 类型的资源对象，可以通过 <code>kubectl explain alertmanagerconfig</code> 或者<a href="https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/user-guides/alerting.md" target="_blank" rel="noopener noreferrer">在线 API 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来查看字段的含义</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># alertmanager-config.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AlertmanagerConfig
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dinghook
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>ops
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
  <span class="token comment"># 标签字段alertmanager中进行匹配</span>
    <span class="token key atrule">alertmanagerConfig</span><span class="token punctuation">:</span> example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">receivers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Critical
      <span class="token key atrule">webhookConfigs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//dingtalk<span class="token punctuation">-</span>hook<span class="token punctuation">:</span><span class="token number">5000</span>
          <span class="token key atrule">sendResolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token key atrule">groupBy</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">,</span> <span class="token string">'cluster'</span><span class="token punctuation">]</span>
    <span class="token key atrule">groupWait</span><span class="token punctuation">:</span> 30s
    <span class="token key atrule">groupInterval</span><span class="token punctuation">:</span> 5m
    <span class="token key atrule">repeatInterval</span><span class="token punctuation">:</span> 12h
    <span class="token key atrule">receiver</span><span class="token punctuation">:</span> Critical
    <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">receiver</span><span class="token punctuation">:</span> Critical
        <span class="token key atrule">match</span><span class="token punctuation">:</span>
          <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>不过如果直接创建上面的配置是不会生效的，我们需要添加一个 Label 标签，并在 Alertmanager 的资源对象中通过标签来关联上面的这个对象，比如我们这里新增了一个 Label 标签：<code>alertmanagerConfig: example</code>，然后需要重新更新 Alertmanager 对象，添加 <code>alertmanagerConfigSelector</code> 属性去匹配 <code>AlertmanagerConfig</code> 资源对象：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># alertmanager-alertmanager.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Alertmanager
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">alertmanager</span><span class="token punctuation">:</span> main
  <span class="token key atrule">name</span><span class="token punctuation">:</span> main
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/prometheus/alertmanager<span class="token punctuation">:</span>v0.21.0
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">2000</span>
    <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> alertmanager<span class="token punctuation">-</span>main
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v0.21.0
  <span class="token key atrule">configSecret</span><span class="token punctuation">:</span>
  <span class="token key atrule">alertmanagerConfigSelector</span><span class="token punctuation">:</span>
  <span class="token comment"># 匹配 AlertmanagerConfig 的标签</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">alertmanagerConfig</span><span class="token punctuation">:</span> example
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>现在我们重新更新上面的资源对象：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl apply -f alertmanager-config.yaml
kubectl apply -f alertmanager-alertmanager.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>更新完成后默认的配置会和我们创建的配置进行合并，我们可以重新查看生成的 Secret 资源对象内容，也可以直接查看 Alertmanager 的 WEB UI 界面的配置内容：</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20211007170610092.png" alt="image-20211007170610092"></p> <p>可以看到我们在 AlertmanagerConfig 里面定义的名为 <code>Critical</code> 的 Receiver</p> <p>在最终生成的配置中名称了 <code>monitoring-dinghook-Critical</code>，格式为 <code>&lt;namespace&gt;-&lt;name&gt;-&lt;receiver name&gt;</code>。</p> <p>钉钉查看告警</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20211007185919233.png" alt="image-20211007185919233"></p> <h2 id="_5、prometheus-operator自动发现"><a href="#_5、prometheus-operator自动发现" class="header-anchor">#</a> 5、Prometheus Operator自动发现</h2> <p>Prometheus Operator 为我们提供了一个额外的抓取配置来解决这个问题，我们可以通过添加额外的配置来进行服务发现进行自动监控。和前面自定义的方式一样，我们可以在 Prometheus Operator 当中去自动发现并监控具有<code>prometheus.io/scrape=true</code> 这个 <code>annotations</code> 的 Service，之前我们定义的 Prometheus 的配置如下：</p> <p><code>prometheus-additional.yaml</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">&quot;kubernetes-endpoints&quot;</span>
  <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> endpoints
  <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_scrape<span class="token punctuation">]</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> keep
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_scheme<span class="token punctuation">]</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __scheme__
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> (https<span class="token punctuation">?</span>)
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_path<span class="token punctuation">]</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __metrics_path__
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.+)
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span>
        <span class="token punctuation">[</span>__address__<span class="token punctuation">,</span> __meta_kubernetes_service_annotation_prometheus_io_port<span class="token punctuation">]</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">[</span>^<span class="token punctuation">:</span><span class="token punctuation">]</span>+)(<span class="token punctuation">?</span><span class="token punctuation">:</span><span class="token punctuation">:</span>\d+)<span class="token punctuation">?</span>;(\d+)
      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1<span class="token punctuation">:</span>$2
    <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_service_label_(.+)
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">]</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_namespace
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_name<span class="token punctuation">]</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_name
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_name<span class="token punctuation">]</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_pod_name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>如果你对上面这个配置还不是很熟悉的话，建议去查看下前面关于 Kubernetes 常用资源对象监控章节的介绍，要想自动发现集群中的 Service，就需要我们在 Service 的 annotation 区域添加 <code>prometheus.io/scrape=true</code> 的声明，将上面文件直接保存为 <code>prometheus-additional.yaml</code>，然后通过这个文件创建一个对应的 Secret 对象：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code> kubectl create secret generic additional-configs --from-file<span class="token operator">=</span>prometheus-additional.yaml -n monitoring
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后我们需要在声明 prometheus 的资源对象文件中通过 <code>additionalScrapeConfigs</code> 属性添加上这个额外的配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># prometheus-prometheus.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Prometheus
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
  <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">alerting</span><span class="token punctuation">:</span>
    <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager<span class="token punctuation">-</span>main
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
        <span class="token key atrule">port</span><span class="token punctuation">:</span> web
  <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/prometheus<span class="token punctuation">:</span>v2.26.0 <span class="token comment"># 使用最新版本的镜像</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
  <span class="token key atrule">podMonitorNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">podMonitorSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">probeNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">probeSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 400Mi
  <span class="token key atrule">ruleSelector</span><span class="token punctuation">:</span> <span class="token comment"># 用来匹配rule规则的selector</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># 匹配的是具有下面两个标签的PrometheusRule这个资源对象</span>
      <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
      <span class="token key atrule">role</span><span class="token punctuation">:</span> alert<span class="token punctuation">-</span>rules
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">2000</span>
    <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
  <span class="token key atrule">serviceMonitorNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">serviceMonitorSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v2.26.0
  <span class="token key atrule">additionalScrapeConfigs</span><span class="token punctuation">:</span>
  <span class="token comment"># 添加字段主要是上面生成的sercret 为additional-configs</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> additional<span class="token punctuation">-</span>configs
    <span class="token key atrule">key</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>additional.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>关于 <code>additionalScrapeConfigs</code> 属性的具体介绍，我们可以使用 <code>kubectl explain</code> 命令来了解详细信息：</p> <p><code>kubectl explain prometheus.spec.additionalScrapeConfigs</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>
KIND:     Prometheus
VERSION:  monitoring.coreos.com/v1

RESOURCE: additionalScrapeConfigs <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>

DESCRIPTION:
     AdditionalScrapeConfigs allows specifying a key of a Secret containing
     additional Prometheus scrape configurations. Scrape configurations
     specified are appended to the configurations generated by the Prometheus
     Operator. Job configurations specified must have the form as specified <span class="token keyword">in</span>
     the official Prometheus documentation:
     https://prometheus.io/docs/prometheus/latest/configuration/configuration/<span class="token comment">#scrape_config.</span>
     As scrape configs are appended, the user is responsible to <span class="token function">make</span> sure it is
     valid. Note that using this feature may expose the possibility to <span class="token builtin class-name">break</span>
     upgrades of Prometheus. It is advised to review Prometheus release notes to
     ensure that no incompatible scrape configs are going to <span class="token builtin class-name">break</span> Prometheus
     after the upgrade.

FIELDS:
   key  <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> -required-
     The key of the secret to <span class="token keyword">select</span> from. Must be a valid secret key.

   name <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
     Name of the referent. More info:
     https://kubernetes.io/docs/concepts/overview/working-with-objects/names/<span class="token comment">#names</span>
     TODO: Add other useful fields. apiVersion, kind, uid?

   optional     <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
     Specify whether the Secret or its key must be defined
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>添加完成后，直接更新 prometheus 这个 CRD 资源对象即可：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl apply -f prometheus-prometheus.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>隔一小会儿，可以前往 Prometheus 的 Dashboard 中查看配置已经生效了：</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/20200418103933.png" alt="Prometheus 配置"></p> <p>但是我们切换到 targets 页面下面却并没有发现对应的监控任务，查看 Prometheus 的 Pod 日志：</p> <p><code>kubectl logs -f prometheus-k8s-0 prometheus -n monitoring</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token assign-left variable">level</span><span class="token operator">=</span>error <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2020</span>-04-18T02:38:27.800Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>klog.go:94 <span class="token assign-left variable">component</span><span class="token operator">=</span>k8s_client_runtime <span class="token assign-left variable">func</span><span class="token operator">=</span>ErrorDepth <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;/app/discovery/kubernetes/kubernetes.go:261: Failed to list *v1.Endpoints: endpoints is forbidden: User <span class="token entity" title="\&quot;">\&quot;</span>system:serviceaccount:monitoring:prometheus-k8s<span class="token entity" title="\&quot;">\&quot;</span> cannot list resource <span class="token entity" title="\&quot;">\&quot;</span>endpoints<span class="token entity" title="\&quot;">\&quot;</span> in API group <span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span> at the cluster scope&quot;</span>
<span class="token assign-left variable">level</span><span class="token operator">=</span>error <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2020</span>-04-18T02:38:27.801Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>klog.go:94 <span class="token assign-left variable">component</span><span class="token operator">=</span>k8s_client_runtime <span class="token assign-left variable">func</span><span class="token operator">=</span>ErrorDepth <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;/app/discovery/kubernetes/kubernetes.go:263: Failed to list *v1.Pod: pods is forbidden: User <span class="token entity" title="\&quot;">\&quot;</span>system:serviceaccount:monitoring:prometheus-k8s<span class="token entity" title="\&quot;">\&quot;</span> cannot list resource <span class="token entity" title="\&quot;">\&quot;</span>pods<span class="token entity" title="\&quot;">\&quot;</span> in API group <span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span> at the cluster scope&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以看到有很多错误日志出现，都是 <code>xxx is forbidden</code>，这说明是 RBAC 权限的问题，通过 prometheus 资源对象的配置可以知道 Prometheus 绑定了一个名为 <code>prometheus-k8s</code> 的 ServiceAccount 对象，而这个对象绑定的是一个名为 <code>prometheus-k8s</code> 的 ClusterRole：</p> <p><code>prometheus-clusterRole.yaml</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nodes/metrics
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /metrics
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>上面的权限规则中我们可以看到明显没有对 Service 或者 Pod 的 <code>list</code> 权限，所以报错了，要解决这个问题，我们只需要添加上需要的权限即可：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nodes
      <span class="token punctuation">-</span> services
      <span class="token punctuation">-</span> endpoints
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> nodes/proxy
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> configmaps
      <span class="token punctuation">-</span> nodes/metrics
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /metrics
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>更新上面的 <code>ClusterRole</code> 这个资源对象，然后重建下 Prometheus 的所有 Pod，正常就可以看到 targets 页面下面有 <code>kubernetes-endpoints</code> 这个监控任务了：</p> <p><img src="https://cdn.jsdelivr.net/gh/lzq70112/images/blog/image-20211007204824259.png" alt="image-20211007204824259"></p> <p>这里发现的几个抓取目标是因为 Service 中都有 <code>prometheus.io/scrape=true</code> 这个 annotation。</p> <h2 id="_6、数据持久化"><a href="#_6、数据持久化" class="header-anchor">#</a> 6、数据持久化</h2> <p>上面我们在修改完权限的时候，重启了 Prometheus 的 Pod，如果我们仔细观察的话会发现我们之前采集的数据已经没有了，这是因为我们通过 prometheus 这个 CRD 创建的 Prometheus 并没有做数据的持久化，我们可以直接查看生成的 Prometheus Pod 的挂载情况就清楚了：</p> <p><code>kubectl get pod prometheus-k8s-0 -n monitoring -o yaml</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
......
    volumeMounts:
    - mountPath: /etc/prometheus/config_out
      name: config-out
      readOnly: true
    - mountPath: /prometheus
      name: prometheus-k8s-db
......
  volumes:
......
  - emptyDir: {}
    name: prometheus-k8s-db
......
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>可以看到 Prometheus 的数据目录 <code>/prometheus</code> 实际上是通过 <code>emptyDir</code> 进行挂载的，我们知道 emptyDir 挂载的数据的生命周期和 Pod 生命周期一致的，所以如果 Pod 挂掉了，数据也就丢失了，这也就是为什么我们重建 Pod 后之前的数据就没有了的原因，对应线上的监控数据肯定需要做数据的持久化的，同样的 prometheus 这个 CRD 资源也为我们提供了数据持久化的配置方法，由于我们的 Prometheus 最终是通过 Statefulset 控制器进行部署的，所以我们这里通过 <code>storageclass</code> 来做数据持久化，</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>此外由于 Prometheus 本身对 NFS 存储没有做相关的支持，<u>所以线上一定不要用 NFS 来做数据持久化</u></p></div> <p>对于如何去为 prometheus 这个 CRD 对象配置存储数据，我们可以去查看官方文档 API，也可以用 <code>kubectl explain</code> 命令去了解：</p> <p><code>kubectl explain prometheus.spec.storage</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">KIND</span><span class="token punctuation">:</span>     Prometheus
<span class="token key atrule">VERSION</span><span class="token punctuation">:</span>  monitoring.coreos.com/v1

<span class="token key atrule">RESOURCE</span><span class="token punctuation">:</span> storage &lt;Object<span class="token punctuation">&gt;</span>

<span class="token key atrule">DESCRIPTION</span><span class="token punctuation">:</span>
     Storage spec to specify how storage shall be used.

<span class="token key atrule">FIELDS</span><span class="token punctuation">:</span>
   emptyDir     &lt;Object<span class="token punctuation">&gt;</span>
     EmptyDirVolumeSource to be used by the Prometheus StatefulSets. If
     specified<span class="token punctuation">,</span> <span class="token key atrule">used in place of any volumeClaimTemplate. More info</span><span class="token punctuation">:</span>
     https<span class="token punctuation">:</span>//kubernetes.io/docs/concepts/storage/volumes/<span class="token comment">#emptydir</span>

   volumeClaimTemplate  &lt;Object<span class="token punctuation">&gt;</span>
     A PVC spec to be used by the Prometheus StatefulSets.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>所以我们在 prometheus 的 CRD 对象中通过 <code>storage</code> 属性配置 <code>volumeClaimTemplate</code> 对象即可：</p> <p><code>prometheus-prometheus.yaml</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span><span class="token punctuation">...</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
  <span class="token key atrule">volumeClaimTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token key atrule">requests</span><span class="token punctuation">:</span>
          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 20Gi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>然后更新 prometheus 这个 CRD 资源，更新完成后会自动生成两个 PVC 和 PV 资源对象：</p> <p><code>kubectl apply -f prometheus-prometheus.yaml</code></p> <p><code>kubectl get pvc -n monitoring</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE
prometheus-k8s-db-prometheus-k8s-0   Bound    pvc-79ad4856-2ab0-4445-814f-958a4699fab9   20Gi       RWO            rook-ceph-block   56s
prometheus-k8s-db-prometheus-k8s-1   Bound    pvc-8eae438e-bf7f-41a3-ae58-d7018c727866   20Gi       RWO            rook-ceph-block   55s
$ kubectl get <span class="token function">pv</span> <span class="token operator">|</span><span class="token function">grep</span> monitoring
pvc-79ad4856-2ab0-4445-814f-958a4699fab9   20Gi       RWO            Retain           Bound      monitoring/prometheus-k8s-db-prometheus-k8s-0          rook-ceph-block            90s
pvc-8eae438e-bf7f-41a3-ae58-d7018c727866   20Gi       RWO            Retain           Bound      monitoring/prometheus-k8s-db-prometheus-k8s-1          rook-ceph-block            90s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>现在我们再去看 Prometheus Pod 的数据目录就可以看到是关联到一个 PVC 对象上了：</p> <p><code>kubectl get pod prometheus-k8s-0 -n monitoring -o yaml</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span><span class="token punctuation">...</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/prometheus/config_out
      <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>out
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /prometheus
      <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db
<span class="token punctuation">...</span><span class="token punctuation">...</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
<span class="token punctuation">...</span><span class="token punctuation">...</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db
    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span><span class="token number">0</span>
<span class="token punctuation">...</span><span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>现在即使我们的 Pod 挂掉了，数据也不会丢失了。到这里 Prometheus Operator 的一些基本配置就算完成了，对于大型的监控集群还需要做一些其他配置，比如前面我们学习的使用 <code>Thanos</code> 来做 Prometheus 集群的高可用已经数据远程存储，对于 Prometheus Operator 来说，要配置 <code>Thanos</code> 也比较简单，因为 prometheus 这个 CRD 对象本身也支持的：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ kubectl explain prometheus.spec.thanos
KIND:     Prometheus
VERSION:  monitoring.coreos.com/v1

RESOURCE: thanos <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>

DESCRIPTION:
     Thanos configuration allows configuring various aspects of a Prometheus
     server <span class="token keyword">in</span> a Thanos environment. This section is experimental, it may change
     significantly without deprecation notice <span class="token keyword">in</span> any release. This is
     experimental and may change significantly without backward compatibility <span class="token keyword">in</span>
     any release.

FIELDS:
   baseImage    <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
     Thanos base image <span class="token keyword">if</span> other than default.

   grpcServerTlsConfig  <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
     GRPCServerTLSConfig configures the gRPC server from <span class="token function">which</span> Thanos Querier
     reads recorded rule data. Note: Currently only the CAFile, CertFile, and
     KeyFile fields are supported. Maps to the <span class="token string">'--grpc-server-tls-*'</span> CLI args.

   image        <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
     Image <span class="token keyword">if</span> specified has precedence over baseImage, tag and sha combinations.
     Specifying the version is still necessary to ensure the Prometheus Operator
     knows what version of Thanos is being configured.

   listenLocal  <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
     ListenLocal makes the Thanos sidecar listen on loopback, so that it does
     not <span class="token builtin class-name">bind</span> against the Pod IP.

   objectStorageConfig  <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
     ObjectStorageConfig configures object storage <span class="token keyword">in</span> Thanos.

   resources    <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
     Resources defines the resource requirements <span class="token keyword">for</span> the Thanos sidecar. If not
     provided, no requests/limits will be <span class="token builtin class-name">set</span>

   sha  <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
     SHA of Thanos container image to be deployed. Defaults to the value of
     <span class="token variable"><span class="token variable">`</span>version<span class="token variable">`</span></span><span class="token builtin class-name">.</span> Similar to a tag, but the SHA explicitly deploys an immutable
     container image. Version and Tag are ignored <span class="token keyword">if</span> SHA is set.

   tag  <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
     Tag of Thanos sidecar container image to be deployed. Defaults to the value
     of <span class="token variable"><span class="token variable">`</span>version<span class="token variable">`</span></span><span class="token builtin class-name">.</span> Version is ignored <span class="token keyword">if</span> Tag is set.

   tracingConfig        <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
     TracingConfig configures tracing <span class="token keyword">in</span> Thanos. This is an experimental
     feature, it may change <span class="token keyword">in</span> any upcoming release <span class="token keyword">in</span> a breaking way.

   version      <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
     Version describes the version of Thanos to use.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><blockquote><p>关于 prometheus operator 中如何配置 thanos，可以查看官方文档的介绍：https://github.com/coreos/prometheus-operator/blob/master/Documentation/thanos.md。</p></blockquote> <p>我们可以看到上面的属性中有一个 <code>objectStorageConfig</code> 字段，该字段也就是用来指定对象存储相关配置的，这里同样我们使用前面 <code>Thanos</code> 章节中的对象存储配置即可：(thanos-storage-minio.yaml)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">type</span><span class="token punctuation">:</span> s3
<span class="token key atrule">config</span><span class="token punctuation">:</span>
  <span class="token key atrule">bucket</span><span class="token punctuation">:</span> promethes<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>data <span class="token comment"># 记得在 minio 中创建这个 bucket</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> minio.minio.svc.cluster.local<span class="token punctuation">:</span><span class="token number">9000</span>
  <span class="token key atrule">access_key</span><span class="token punctuation">:</span> minio
  <span class="token key atrule">secret_key</span><span class="token punctuation">:</span> minio123
  <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">signature_version2</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>使用上面的配置文件创建一个对应的 Secret 资源对象：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kubectl -n monitoring create secret generic thanos-objectstorage --from-file<span class="token operator">=</span>thanos.yaml<span class="token operator">=</span>thanos-storage-minio.yaml
secret/thanos-objectstorage created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>创建完成后在 prometheus 的 CRD 对象中添加如下配置：(prometheus-prometheus.yaml )</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">thanos</span><span class="token punctuation">:</span>
  <span class="token key atrule">objectStorageConfig</span><span class="token punctuation">:</span>
    <span class="token key atrule">key</span><span class="token punctuation">:</span> thanos.yaml
    <span class="token key atrule">name</span><span class="token punctuation">:</span> thanos<span class="token punctuation">-</span>objectstorage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后直接更新 prometheus 这个 CRD 对象即可：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ kubectl apply -f prometheus-prometheus.yaml
prometheus.monitoring.coreos.com/k8s configured
$ kubectl get pods -n monitoring -l <span class="token assign-left variable">app</span><span class="token operator">=</span>prometheus
NAME               READY   STATUS    RESTARTS   AGE
prometheus-k8s-0   <span class="token number">4</span>/4     Running   <span class="token number">1</span>          11m
prometheus-k8s-1   <span class="token number">4</span>/4     Running   <span class="token number">0</span>          11m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>更新完成后，可以看到 Prometheus 的 Pod 变成了 4 个容器，新增了一个 sidecar 容器：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl get pod prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0 <span class="token punctuation">-</span>n monitoring <span class="token punctuation">-</span>o yaml
<span class="token punctuation">...</span><span class="token punctuation">...</span>
  <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> sidecar
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>prometheus.url=http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>9090/
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tsdb.path=/prometheus
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>grpc<span class="token punctuation">-</span>address=<span class="token punctuation">[</span>$(POD_IP)<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">10901</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>http<span class="token punctuation">-</span>address=<span class="token punctuation">[</span>$(POD_IP)<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">10902</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>objstore.config=$(OBJSTORE_CONFIG)
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_IP
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
        <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
          <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.podIP
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> OBJSTORE_CONFIG
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
        <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">key</span><span class="token punctuation">:</span> thanos.yaml
          <span class="token key atrule">name</span><span class="token punctuation">:</span> thanos<span class="token punctuation">-</span>objectstorage
    <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/thanos/thanos<span class="token punctuation">:</span>v0.11.0
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> thanos<span class="token punctuation">-</span>sidecar
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">10902</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">10901</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
<span class="token punctuation">...</span><span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>这个其实和前面课程中学习的手动方式部署 Thanos 非常类似，现在相当于我们将 Prometheus 的数据输出到了远程对象存储上面去了，但是这还只是第一步，我们还需要部署其他的 Thanos 组件，比如 Querier、Store、Compactor 等，这些内容其实前面章节我们已经详细讲解过了，这里我们就不再赘述了。</p> <p>最后我们查看下面我们的 prometheus 的 CRD 对象的完整配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Prometheus
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
  <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">alerting</span><span class="token punctuation">:</span>
    <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager<span class="token punctuation">-</span>main
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
        <span class="token key atrule">port</span><span class="token punctuation">:</span> web
  <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/prometheus<span class="token punctuation">:</span>v2.26.0
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
  <span class="token key atrule">podMonitorNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">podMonitorSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">retention</span><span class="token punctuation">:</span> 6h <span class="token comment"># 本地只保留6h小时的数据</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 400Mi
  <span class="token key atrule">ruleSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
      <span class="token key atrule">role</span><span class="token punctuation">:</span> alert<span class="token punctuation">-</span>rules
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">2000</span>
    <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
  <span class="token key atrule">serviceMonitorNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">serviceMonitorSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v2.26.0
  <span class="token key atrule">additionalScrapeConfigs</span><span class="token punctuation">:</span> <span class="token comment"># 添加服务发现的配置</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> additional<span class="token punctuation">-</span>configs
    <span class="token key atrule">key</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>additional.yaml
  <span class="token key atrule">storage</span><span class="token punctuation">:</span> <span class="token comment"># 添加本地数据持久化</span>
    <span class="token key atrule">volumeClaimTemplate</span><span class="token punctuation">:</span>
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 20Gi
  <span class="token key atrule">thanos</span><span class="token punctuation">:</span> <span class="token comment">#  添加 thanos 配置</span>
    <span class="token key atrule">objectStorageConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">key</span><span class="token punctuation">:</span> thanos.yaml
      <span class="token key atrule">name</span><span class="token punctuation">:</span> thanos<span class="token punctuation">-</span>objectstorage <span class="token comment"># 对象存储对应的 secret 资源对象</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>当然如果最后配置了 Thanos，那么 Grafana 的数据源也需要更改成 Querier 组件的地址，否则就只是本地的数据。</p></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/lzq70112/lzq70112.github.io/edit/master/docs/《Prometheus》学习笔记/10.Prometheus之Operator.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Prometheus" title="标签">#Prometheus</a><a href="/tags/?tag=Operator" title="标签">#Operator</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/07/18, 19:58:00</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/b5e11116/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Prometheus之Alertmanager的安装使用</div></a> <a href="/pages/Prometheus1000/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Prometheus之rules大全</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/b5e11116/" class="prev">Prometheus之Alertmanager的安装使用</a></span> <span class="next"><a href="/pages/Prometheus1000/">Prometheus之rules大全</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/ansible8/"><div>
            ansibleplaybook常用模块
            <!----></div></a> <span class="date">06-22</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/k8s110/"><div>
            kubelet硬件资源驱逐策略
            <!----></div></a> <span class="date">06-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/k8s111/"><div>
            k8s云存储nfs的nolock详解
            <!----></div></a> <span class="date">06-03</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:498510210@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/lzq70112" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>xiongmao | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank" rel="nofollow">MIT License</a> <a href="https://hongwei888.com/sitemap.xml" target="_blank">站点地图</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.e7221624.js" defer></script><script src="/assets/js/2.1e679d1d.js" defer></script><script src="/assets/js/171.8d1021c2.js" defer></script>
  </body>
</html>
